<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VQuail - Smart Quail Farming Monitor & Control</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 50px;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-card {
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .status-online {
            border-left: 5px solid var(--success-color);
        }
        
        .status-offline {
            border-left: 5px solid var(--danger-color);
        }
        
        .status-warning {
            border-left: 5px solid var(--warning-color);
        }
        
        .control-btn {
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .temperature-display {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .humidity-display {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gauge-container {
            position: relative;
            margin: 20px auto;
        }
        
        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .mode-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .mode-auto {
            background-color: rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
        }
        
        .mode-manual {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }
        
        .control-channel {
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .channel-tft {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--success-color);
        }
        
        .channel-web {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }
        
        .channel-auto {
            background-color: rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
        }
        
        .alarm-banner {
            animation: pulse 2s infinite;
            border-radius: 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 0.85rem;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .custom-range::-webkit-slider-thumb {
            background: var(--secondary-color);
        }
        
        .custom-range::-moz-range-thumb {
            background: var(--secondary-color);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .device-status {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .device-on {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success-color);
        }
        
        .device-off {
            background-color: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }
        
        .sensor-value {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .temperature-display, .humidity-display {
                font-size: 2rem;
            }
            
            h4 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-1"><i class="fas fa-dove text-primary me-2"></i> VQuail System</h1>
                            <p class="text-muted mb-0">Smart Quail Farming Monitor & Control Panel</p>
                        </div>
                        <div class="text-end">
                            <div id="currentTime" class="h5 mb-1">--:--:--</div>
                            <div id="currentDate" class="text-muted small">----/--/--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alarm Banner -->
        <div id="alarmBanner" class="row mb-4 d-none">
            <div class="col-12">
                <div class="alarm-banner bg-danger text-white p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="alarmMessage">Alarm Message</span>
                            <span id="alarmSource" class="badge bg-light text-dark ms-2">SOURCE</span>
                        </div>
                        <button id="dismissAlarm" class="btn btn-sm btn-light">
                            <i class="fas fa-times"></i> Dismiss
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="row mb-4">
            <!-- Sensor Data -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="glass-card status-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="fas fa-thermometer-half text-danger me-2"></i> Temperature</h4>
                        <div class="temperature-display" id="temperatureValue">--.-</div>
                    </div>
                    <div class="progress mb-2" style="height: 10px;">
                        <div id="tempProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Min: <span id="tempMin">--</span>°C</span>
                        <span>Max: <span id="tempMax">--</span>°C</span>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Calibration:</span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="adjustTemp(-0.5)">-0.5</button>
                                <span class="mx-2" id="tempOffset">0.0°C</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="adjustTemp(0.5)">+0.5</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-4">
                <div class="glass-card status-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="fas fa-tint text-info me-2"></i> Humidity</h4>
                        <div class="humidity-display" id="humidityValue">--.-</div>
                    </div>
                    <div class="progress mb-2" style="height: 10px;">
                        <div id="humProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Min: <span id="humMin">--</span>%</span>
                        <span>Max: <span id="humMax">--</span>%</span>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Calibration:</span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="adjustHum(-0.5)">-0.5</button>
                                <span class="mx-2" id="humOffset">0.0%</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="adjustHum(0.5)">+0.5</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="glass-card status-card p-4 h-100">
                    <h4 class="mb-3"><i class="fas fa-heartbeat text-primary me-2"></i> System Status</h4>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Life Stage:</span>
                            <span class="fw-bold" id="lifeStage">--</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Age:</span>
                            <span id="ageDays">-- days</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Control:</span>
                            <span id="controlChannel" class="control-channel channel-auto">AUTO</span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="device-status device-off mb-2">
                                <i class="fas fa-wind me-1"></i> Fan: <span id="fanStatus">OFF</span>
                            </div>
                            <div class="device-status device-off">
                                <i class="fas fa-fire me-1"></i> Heat: <span id="heatStatus">OFF</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="device-status device-off mb-2">
                                <i class="fas fa-wifi me-1"></i> WiFi: <span id="wifiStatus">OFF</span>
                            </div>
                            <div class="device-status device-off">
                                <i class="fas fa-satellite-dish me-1"></i> MQTT: <span id="mqttStatus">OFF</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h4 class="mb-4"><i class="fas fa-gamepad text-warning me-2"></i> Control Panel</h4>
                    
                    <div class="row">
                        <!-- Mode Selection -->
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Operation Mode</h5>
                                    <p class="card-text text-muted small mb-3">
                                        <span id="modeDescription">
                                            In AUTO mode, devices are controlled automatically based on sensor readings.
                                            Manual control is disabled.
                                        </span>
                                    </p>
                                    <div class="d-grid gap-2">
                                        <button id="btnAuto" class="btn btn-primary control-btn">
                                            <i class="fas fa-robot me-2"></i> AUTO Mode
                                        </button>
                                        <button id="btnManual" class="btn btn-warning control-btn">
                                            <i class="fas fa-hand-paper me-2"></i> MANUAL Mode
                                        </button>
                                    </div>
                                    <div class="mt-3 text-center">
                                        <span id="currentMode" class="mode-indicator mode-auto">AUTO MODE ACTIVE</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device Control -->
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Device Control</h5>
                                    <p class="card-text text-muted small mb-3" id="controlInstructions">
                                        Manual control is only available in MANUAL mode.
                                    </p>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="d-grid gap-2">
                                                <button id="btnFanOn" class="btn btn-success control-btn" disabled>
                                                    <i class="fas fa-wind me-2"></i> Turn FAN ON
                                                </button>
                                                <button id="btnFanOff" class="btn btn-outline-secondary control-btn" disabled>
                                                    <i class="fas fa-wind me-2"></i> Turn FAN OFF
                                                </button>
                                                <div class="text-center mt-2">
                                                    <small class="text-muted">Current: <span id="fanCurrent">OFF</span></small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="d-grid gap-2">
                                                <button id="btnHeatOn" class="btn btn-danger control-btn" disabled>
                                                    <i class="fas fa-fire me-2"></i> Turn HEAT ON
                                                </button>
                                                <button id="btnHeatOff" class="btn btn-outline-secondary control-btn" disabled>
                                                    <i class="fas fa-fire me-2"></i> Turn HEAT OFF
                                                </button>
                                                <div class="text-center mt-2">
                                                    <small class="text-muted">Current: <span id="heatCurrent">OFF</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="d-grid">
                                                <button id="btnBothOn" class="btn btn-info control-btn" disabled>
                                                    <i class="fas fa-power-off me-2"></i> Turn BOTH ON
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-grid">
                                                <button id="btnBothOff" class="btn btn-outline-dark control-btn" disabled>
                                                    <i class="fas fa-power-off me-2"></i> Turn BOTH OFF
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Controls & Logs -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="glass-card p-4 h-100">
                    <ul class="nav nav-tabs" id="advancedTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                                <i class="fas fa-cogs me-1"></i> Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calibration-tab" data-bs-toggle="tab" data-bs-target="#calibration" type="button" role="tab">
                                <i class="fas fa-sliders-h me-1"></i> Calibration
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="advancedTabContent">
                        <!-- Settings Tab -->
                        <div class="tab-pane fade show active" id="settings" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Life Stage Selection</label>
                                        <select id="stageSelect" class="form-select" onchange="changeStage(this.value)">
                                            <option value="0">Brooding Week 1</option>
                                            <option value="1">Brooding Week 2</option>
                                            <option value="2">Grower (Week 3-6)</option>
                                            <option value="3">Adult Layer</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Age (days): <span id="ageValue">0</span></label>
                                        <input type="range" class="form-range" id="ageSlider" min="0" max="70" value="0" onchange="changeAge(this.value)">
                                        <div class="d-flex justify-content-between">
                                            <small>0</small>
                                            <small>70</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">System Actions</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="forceRefresh()">
                                                <i class="fas fa-sync-alt me-2"></i> Force Refresh
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="rebootSystem()">
                                                <i class="fas fa-redo me-2"></i> Reboot System
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="resetCalibration()">
                                                <i class="fas fa-undo me-2"></i> Reset Calibration
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Connection Status</label>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Sensor:</span>
                                            <span id="sensorStatus" class="badge bg-secondary">--</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>SD Card:</span>
                                            <span id="sdStatus" class="badge bg-secondary">--</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Uptime:</span>
                                            <span id="uptime">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calibration Tab -->
                        <div class="tab-pane fade" id="calibration" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Temperature Calibration</h6>
                                            <p class="card-text text-muted small">
                                                Adjust if temperature readings are consistently off.
                                            </p>
                                            <div class="text-center mb-3">
                                                <div class="h3" id="tempCalValue">0.0°C</div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-danger" onclick="adjustCalibration('temp', -1)">-1.0</button>
                                                <button class="btn btn-outline-warning" onclick="adjustCalibration('temp', -0.5)">-0.5</button>
                                                <button class="btn btn-outline-success" onclick="adjustCalibration('temp', 0.5)">+0.5</button>
                                                <button class="btn btn-outline-primary" onclick="adjustCalibration('temp', 1)">+1.0</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Humidity Calibration</h6>
                                            <p class="card-text text-muted small">
                                                Adjust if humidity readings are consistently off.
                                            </p>
                                            <div class="text-center mb-3">
                                                <div class="h3" id="humCalValue">0.0%</div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-danger" onclick="adjustCalibration('hum', -2)">-2%</button>
                                                <button class="btn btn-outline-warning" onclick="adjustCalibration('hum', -1)">-1%</button>
                                                <button class="btn btn-outline-success" onclick="adjustCalibration('hum', 1)">+1%</button>
                                                <button class="btn btn-outline-primary" onclick="adjustCalibration('hum', 2)">+2%</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Calibration changes are saved automatically. Use small adjustments and monitor the results.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="col-lg-4 mb-4">
                <div class="glass-card p-4 h-100">
                    <h4 class="mb-3"><i class="fas fa-history text-info me-2"></i> Activity Log</h4>
                    <div id="activityLog" style="height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4" id="emptyLog">
                            <i class="fas fa-comment-slash fa-2x mb-2"></i><br>
                            No activity yet
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="fas fa-trash me-1"></i> Clear Log
                        </button>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="exportLog()">
                            <i class="fas fa-download me-1"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status Bar -->
        <div class="row fixed-bottom d-none d-md-block">
            <div class="col-12">
                <div class="bg-dark text-white p-2">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <small>
                                    <i class="fas fa-microchip me-1"></i>
                                    <span id="connectionStatus">Connecting to VQuail System...</span>
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <small>
                                    <span class="me-3" id="lastUpdate">Last update: --:--:--</span>
                                    <span id="messageCount">Messages: 0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MQTT Configuration Modal -->
    <div class="modal fade" id="mqttConfigModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-satellite-dish me-2"></i> MQTT Connection</h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p>Connecting to HiveMQ Cloud...</p>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Make sure your VQuail system is powered on and connected to WiFi.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    
    <script>
        // Configuration
        const config = {
            mqtt: {
                host: "514ee1c5407448169298c78647ad26b9.s1.eu.hivemq.cloud",
                port: 8883,
                username: "vquail",
                password: "Vquail12345",
                clientId: "vquail-web-" + Math.random().toString(16).substr(2, 8)
            },
            topics: {
                subscribe: [
                    "vquail/status/device",
                    "vquail/status/sensors",
                    "vquail/status/system"
                ],
                publish: {
                    control: "vquail/web/control",
                    calibration: "vquail/calibration"
                }
            },
            refreshInterval: 5000, // 5 seconds
            reconnectDelay: 5000,
            stages: [
                { name: "Brood W1", tempMin: 35, tempMax: 37, humMin: 60, humMax: 70 },
                { name: "Brood W2", tempMin: 32, tempMax: 35, humMin: 60, humMax: 70 },
                { name: "Grower", tempMin: 24, tempMax: 28, humMin: 55, humMax: 65 },
                { name: "Adult", tempMin: 20, tempMax: 24, humMin: 50, humMax: 60 }
            ]
        };

        // Global Variables
        let mqttClient = null;
        let isConnected = false;
        let systemData = {
            temp: null,
            hum: null,
            fan: false,
            heat: false,
            autoMode: true,
            stage: 0,
            age: 0,
            sensorOnline: false,
            sensorDisconnected: false,
            alarm: null,
            controlChannel: "AUTO",
            tempOffset: 0,
            humOffset: 0,
            wifi: false,
            mqtt: false,
            sdCard: false,
            tft: false,
            uptime: "0s"
        };
        let messageCount = 0;
        let activityLog = [];
        let lastUpdateTime = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMQTT();
            initUI();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(checkConnection, 10000);
        });

        // MQTT Functions
        function initMQTT() {
            const host = config.mqtt.host;
            const port = config.mqtt.port;
            const clientId = config.mqtt.clientId;
            
            mqttClient = new Paho.MQTT.Client(host, Number(port), clientId);
            
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            
            const options = {
                useSSL: true,
                userName: config.mqtt.username,
                password: config.mqtt.password,
                onSuccess: onConnect,
                onFailure: onConnectFailure,
                reconnect: true,
                keepAliveInterval: 60,
                cleanSession: true
            };
            
            // Show connecting modal
            const modal = new bootstrap.Modal(document.getElementById('mqttConfigModal'));
            modal.show();
            
            mqttClient.connect(options);
        }

        function onConnect() {
            console.log("MQTT Connected");
            isConnected = true;
            
            // Subscribe to topics
            config.topics.subscribe.forEach(topic => {
                mqttClient.subscribe(topic, { qos: 1 });
                console.log("Subscribed to: " + topic);
            });
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('mqttConfigModal')).hide();
            
            // Request full status update
            publishControl({ request: "full" }, "vquail/status/request");
            
            // Update UI
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-check-circle text-success me-1"></i> Connected to VQuail System';
            
            addLogEntry("Connected to MQTT broker", "success");
        }

        function onConnectFailure(error) {
            console.error("MQTT Connection Failed:", error);
            isConnected = false;
            
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-times-circle text-danger me-1"></i> Connection failed. Retrying...';
            
            addLogEntry("MQTT connection failed: " + error.errorMessage, "error");
            
            // Retry connection after delay
            setTimeout(initMQTT, config.reconnectDelay);
        }

        function onConnectionLost(response) {
            console.error("MQTT Connection Lost:", response);
            isConnected = false;
            
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-times-circle text-danger me-1"></i> Connection lost. Reconnecting...';
            
            addLogEntry("MQTT connection lost: " + response.errorMessage, "error");
            
            // Attempt reconnect
            setTimeout(initMQTT, config.reconnectDelay);
        }

        function onMessageArrived(message) {
            try {
                messageCount++;
                document.getElementById('messageCount').textContent = "Messages: " + messageCount;
                
                const payload = JSON.parse(message.payloadString);
                const topic = message.destinationName;
                
                lastUpdateTime = new Date();
                
                // Process message based on topic
                if (topic === "vquail/status/device") {
                    updateDeviceStatus(payload);
                } else if (topic === "vquail/status/sensors") {
                    updateSensorData(payload);
                } else if (topic === "vquail/status/system") {
                    updateSystemStatus(payload);
                }
                
                // Update last update time
                updateLastUpdateTime();
                
            } catch (error) {
                console.error("Error processing message:", error);
                addLogEntry("Error processing message: " + error.message, "error");
            }
        }

        function publishControl(data, customTopic = null) {
            if (!isConnected || !mqttClient) {
                addLogEntry("Cannot send command: Not connected to MQTT", "error");
                return;
            }
            
            const topic = customTopic || config.topics.publish.control;
            const message = new Paho.MQTT.Message(JSON.stringify(data));
            message.destinationName = topic;
            message.qos = 1;
            
            mqttClient.send(message);
            
            console.log("Published to", topic, ":", data);
        }

        // UI Update Functions
        function updateDeviceStatus(data) {
            // Update basic device status
            systemData.fan = data.fan || false;
            systemData.heat = data.heat || false;
            systemData.autoMode = data.auto || true;
            systemData.stage = data.stage || "Unknown";
            systemData.age = data.age || 0;
            systemData.sensorOnline = data.sensor_online || false;
            systemData.sensorDisconnected = data.sensor_disconnected || false;
            systemData.controlChannel = data.control_channel || "AUTO";
            systemData.tempOffset = data.temp_offset || 0;
            systemData.humOffset = data.hum_offset || 0;
            systemData.uptime = data.uptime || "0s";
            
            // Update alarm status
            if (data.alarm_active && data.alarm) {
                showAlarm(data.alarm, data.alarm_source || "System");
            } else {
                hideAlarm();
            }
            
            // Update UI elements
            updateDeviceUI();
        }

        function updateSensorData(data) {
            systemData.temp = data.temp || null;
            systemData.hum = data.hum || null;
            
            // Update UI
            document.getElementById('temperatureValue').textContent = 
                systemData.temp !== null ? systemData.temp.toFixed(1) : "--.-";
            document.getElementById('humidityValue').textContent = 
                systemData.hum !== null ? systemData.hum.toFixed(1) : "--.-";
            
            // Update calibration displays
            document.getElementById('tempOffset').textContent = 
                systemData.tempOffset.toFixed(1) + "°C";
            document.getElementById('humOffset').textContent = 
                systemData.humOffset.toFixed(1) + "%";
            document.getElementById('tempCalValue').textContent = 
                systemData.tempOffset.toFixed(1) + "°C";
            document.getElementById('humCalValue').textContent = 
                systemData.humOffset.toFixed(1) + "%";
            
            // Update progress bars
            if (systemData.temp !== null) {
                const stageConfig = config.stages[systemData.stage] || config.stages[0];
                const tempRange = stageConfig.tempMax - stageConfig.tempMin;
                const tempProgress = ((systemData.temp - stageConfig.tempMin) / tempRange) * 100;
                document.getElementById('tempProgress').style.width = 
                    Math.min(Math.max(tempProgress, 0), 100) + "%";
            }
            
            if (systemData.hum !== null) {
                const stageConfig = config.stages[systemData.stage] || config.stages[0];
                const humRange = stageConfig.humMax - stageConfig.humMin;
                const humProgress = ((systemData.hum - stageConfig.humMin) / humRange) * 100;
                document.getElementById('humProgress').style.width = 
                    Math.min(Math.max(humProgress, 0), 100) + "%";
            }
        }

        function updateSystemStatus(data) {
            systemData.wifi = data.wifi || false;
            systemData.mqtt = data.mqtt || false;
            systemData.sdCard = data.sd_card || false;
            systemData.tft = data.tft || false;
            
            // Update status indicators
            updateStatusIndicators();
        }

        function updateDeviceUI() {
            // Update device status
            document.getElementById('fanStatus').textContent = systemData.fan ? "ON" : "OFF";
            document.getElementById('heatStatus').textContent = systemData.heat ? "ON" : "OFF";
            document.getElementById('fanCurrent').textContent = systemData.fan ? "ON" : "OFF";
            document.getElementById('heatCurrent').textContent = systemData.heat ? "ON" : "OFF";
            
            // Update WiFi and MQTT status
            document.getElementById('wifiStatus').textContent = systemData.wifi ? "ON" : "OFF";
            document.getElementById('mqttStatus').textContent = systemData.mqtt ? "ON" : "OFF";
            
            // Update device status classes
            document.querySelectorAll('.device-status')[0].className = 
                `device-status ${systemData.fan ? 'device-on' : 'device-off'} mb-2`;
            document.querySelectorAll('.device-status')[1].className = 
                `device-status ${systemData.heat ? 'device-on' : 'device-off'}`;
            document.querySelectorAll('.device-status')[2].className = 
                `device-status ${systemData.wifi ? 'device-on' : 'device-off'} mb-2`;
            document.querySelectorAll('.device-status')[3].className = 
                `device-status ${systemData.mqtt ? 'device-on' : 'device-off'}`;
            
            // Update stage and age
            document.getElementById('lifeStage').textContent = systemData.stage;
            document.getElementById('ageDays').textContent = systemData.age + " days";
            document.getElementById('ageValue').textContent = systemData.age;
            document.getElementById('ageSlider').value = systemData.age;
            
            // Update stage select
            document.getElementById('stageSelect').value = getStageIndex(systemData.stage);
            
            // Update stage limits
            const stageIndex = getStageIndex(systemData.stage);
            if (stageIndex >= 0) {
                const stage = config.stages[stageIndex];
                document.getElementById('tempMin').textContent = stage.tempMin;
                document.getElementById('tempMax').textContent = stage.tempMax;
                document.getElementById('humMin').textContent = stage.humMin;
                document.getElementById('humMax').textContent = stage.humMax;
            }
            
            // Update mode display
            updateModeUI();
            
            // Update control channel
            updateControlChannelUI();
            
            // Update sensor status
            let sensorStatus = "OK";
            if (systemData.sensorDisconnected) {
                sensorStatus = "DISCONNECTED";
            } else if (!systemData.sensorOnline) {
                sensorStatus = "OFFLINE";
            }
            document.getElementById('sensorStatus').className = 
                `badge ${sensorStatus === 'OK' ? 'bg-success' : sensorStatus === 'OFFLINE' ? 'bg-warning' : 'bg-danger'}`;
            document.getElementById('sensorStatus').textContent = sensorStatus;
            
            // Update SD card status
            document.getElementById('sdStatus').className = 
                `badge ${systemData.sdCard ? 'bg-success' : 'bg-danger'}`;
            document.getElementById('sdStatus').textContent = systemData.sdCard ? "OK" : "ERROR";
            
            // Update uptime
            document.getElementById('uptime').textContent = formatUptime(systemData.uptime);
        }

        function updateModeUI() {
            const isAutoMode = systemData.autoMode;
            
            // Update mode buttons
            document.getElementById('btnAuto').className = 
                `btn ${isAutoMode ? 'btn-primary' : 'btn-outline-primary'} control-btn`;
            document.getElementById('btnManual').className = 
                `btn ${!isAutoMode ? 'btn-warning' : 'btn-outline-warning'} control-btn`;
            
            // Update mode indicator
            document.getElementById('currentMode').className = 
                `mode-indicator ${isAutoMode ? 'mode-auto' : 'mode-manual'}`;
            document.getElementById('currentMode').textContent = 
                isAutoMode ? 'AUTO MODE ACTIVE' : 'MANUAL MODE ACTIVE';
            
            // Update control instructions
            document.getElementById('controlInstructions').textContent = isAutoMode ? 
                'Devices are controlled automatically based on sensor readings. Manual control is disabled in AUTO mode.' :
                'Manual control is active. Use the buttons below to control devices.';
            
            // Enable/disable control buttons
            const controlButtons = [
                'btnFanOn', 'btnFanOff', 'btnHeatOn', 'btnHeatOff', 'btnBothOn', 'btnBothOff'
            ];
            
            controlButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.disabled = isAutoMode;
                if (isAutoMode) {
                    btn.className = btn.className.replace('btn-success btn-danger btn-info', 'btn-outline-secondary');
                } else {
                    // Update button colors based on current state
                    if (btnId === 'btnFanOn') btn.className = 'btn btn-success control-btn';
                    if (btnId === 'btnFanOff') btn.className = 'btn btn-outline-secondary control-btn';
                    if (btnId === 'btnHeatOn') btn.className = 'btn btn-danger control-btn';
                    if (btnId === 'btnHeatOff') btn.className = 'btn btn-outline-secondary control-btn';
                    if (btnId === 'btnBothOn') btn.className = 'btn btn-info control-btn';
                    if (btnId === 'btnBothOff') btn.className = 'btn btn-outline-dark control-btn';
                }
            });
        }

        function updateControlChannelUI() {
            const channel = systemData.controlChannel || "AUTO";
            const element = document.getElementById('controlChannel');
            
            element.textContent = channel;
            element.className = `control-channel ${
                channel === 'TFT' ? 'channel-tft' :
                channel === 'WEB' ? 'channel-web' : 'channel-auto'
            }`;
        }

        function updateStatusIndicators() {
            // Update connection status bar
            if (isConnected && systemData.mqtt) {
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-check-circle text-success me-1"></i> Connected to VQuail System';
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-times-circle text-danger me-1"></i> Disconnected';
            }
        }

        // Control Functions
        function setFan(state) {
            if (!isConnected) return;
            
            publishControl({ fan: state });
            addLogEntry(`Fan turned ${state ? 'ON' : 'OFF'}`, "control");
        }

        function setHeat(state) {
            if (!isConnected) return;
            
            publishControl({ heat: state });
            addLogEntry(`Heat lamp turned ${state ? 'ON' : 'OFF'}`, "control");
        }

        function setAutoMode(isAuto) {
            if (!isConnected) return;
            
            publishControl({ auto: isAuto });
            addLogEntry(`Switched to ${isAuto ? 'AUTO' : 'MANUAL'} mode`, "mode");
        }

        function adjustTemp(amount) {
            if (!isConnected) return;
            
            const newOffset = systemData.tempOffset + amount;
            publishControl({ temp_offset: newOffset }, config.topics.publish.calibration);
            addLogEntry(`Temperature calibration adjusted by ${amount.toFixed(1)}°C`, "calibration");
        }

        function adjustHum(amount) {
            if (!isConnected) return;
            
            const newOffset = systemData.humOffset + amount;
            publishControl({ hum_offset: newOffset }, config.topics.publish.calibration);
            addLogEntry(`Humidity calibration adjusted by ${amount.toFixed(1)}%`, "calibration");
        }

        function adjustCalibration(type, amount) {
            if (type === 'temp') {
                adjustTemp(amount);
            } else if (type === 'hum') {
                adjustHum(amount);
            }
        }

        function resetCalibration() {
            if (!isConnected) return;
            
            if (confirm("Are you sure you want to reset all calibration to zero?")) {
                publishControl({ reset: true }, config.topics.publish.calibration);
                addLogEntry("Calibration reset to defaults", "calibration");
            }
        }

        function changeStage(stageIndex) {
            if (!isConnected) return;
            
            // Find stage by index
            const stage = config.stages[stageIndex];
            if (stage) {
                // Update local data
                systemData.stage = stage.name;
                systemData.age = 0; // Reset age when changing stage
                
                // Send update
                publishControl({ 
                    stage: stageIndex,
                    age: 0
                });
                
                addLogEntry(`Stage changed to ${stage.name}`, "settings");
            }
        }

        function changeAge(age) {
            if (!isConnected) return;
            
            publishControl({ age: parseInt(age) });
            addLogEntry(`Age set to ${age} days`, "settings");
        }

        function forceRefresh() {
            if (!isConnected) return;
            
            publishControl({ request: "full" }, "vquail/status/request");
            addLogEntry("Requested full system status update", "system");
        }

        function rebootSystem() {
            if (!isConnected) return;
            
            if (confirm("Are you sure you want to reboot the VQuail system?")) {
                publishControl({ reboot: true });
                addLogEntry("System reboot requested", "system");
            }
        }

        // UI Helper Functions
        function initUI() {
            // Setup event listeners for control buttons
            document.getElementById('btnFanOn').addEventListener('click', () => setFan(true));
            document.getElementById('btnFanOff').addEventListener('click', () => setFan(false));
            document.getElementById('btnHeatOn').addEventListener('click', () => setHeat(true));
            document.getElementById('btnHeatOff').addEventListener('click', () => setHeat(false));
            document.getElementById('btnBothOn').addEventListener('click', () => {
                setFan(true);
                setHeat(true);
            });
            document.getElementById('btnBothOff').addEventListener('click', () => {
                setFan(false);
                setHeat(false);
            });
            document.getElementById('btnAuto').addEventListener('click', () => setAutoMode(true));
            document.getElementById('btnManual').addEventListener('click', () => setAutoMode(false));
            document.getElementById('dismissAlarm').addEventListener('click', hideAlarm);
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function showAlarm(message, source) {
            const banner = document.getElementById('alarmBanner');
            const messageEl = document.getElementById('alarmMessage');
            const sourceEl = document.getElementById('alarmSource');
            
            messageEl.textContent = message;
            sourceEl.textContent = source;
            
            banner.classList.remove('d-none');
            
            // Play alert sound if not already playing
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.play();
            } catch (e) {}
            
            // Add to log
            addLogEntry(`ALARM: ${message} (${source})`, "alarm");
        }

        function hideAlarm() {
            document.getElementById('alarmBanner').classList.add('d-none');
        }

        function addLogEntry(message, type = "info") {
            const timestamp = luxon.DateTime.now().toFormat('HH:mm:ss');
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            activityLog.unshift(logEntry);
            if (activityLog.length > 50) activityLog = activityLog.slice(0, 50);
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('activityLog');
            const emptyLog = document.getElementById('emptyLog');
            
            if (activityLog.length === 0) {
                emptyLog.classList.remove('d-none');
                return;
            }
            
            emptyLog.classList.add('d-none');
            
            // Clear and rebuild log display
            logContainer.innerHTML = '';
            
            activityLog.forEach(entry => {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry bg-${getLogBgColor(entry.type)}`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-muted me-2';
                timeSpan.textContent = entry.time;
                
                const messageSpan = document.createElement('span');
                messageSpan.textContent = entry.message;
                
                logDiv.appendChild(timeSpan);
                logDiv.appendChild(messageSpan);
                logContainer.appendChild(logDiv);
            });
        }

        function getLogBgColor(type) {
            switch(type) {
                case 'success': return 'success bg-opacity-10';
                case 'error': return 'danger bg-opacity-10';
                case 'warning': return 'warning bg-opacity-10';
                case 'alarm': return 'danger bg-opacity-25';
                case 'control': return 'primary bg-opacity-10';
                case 'calibration': return 'info bg-opacity-10';
                case 'settings': return 'secondary bg-opacity-10';
                case 'mode': return 'warning bg-opacity-10';
                case 'system': return 'dark bg-opacity-10';
                default: return 'light';
            }
        }

        function clearLog() {
            if (confirm("Clear all log entries?")) {
                activityLog = [];
                updateLogDisplay();
                addLogEntry("Log cleared", "system");
            }
        }

        function exportLog() {
            const logText = activityLog.map(entry => 
                `[${entry.time}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vquail-log-${luxon.DateTime.now().toFormat('yyyy-MM-dd-HHmm')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLogEntry("Log exported", "system");
        }

        function updateTime() {
            const now = luxon.DateTime.now();
            document.getElementById('currentTime').textContent = now.toFormat('HH:mm:ss');
            document.getElementById('currentDate').textContent = now.toFormat('yyyy/MM/dd');
        }

        function updateLastUpdateTime() {
            if (!lastUpdateTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - lastUpdateTime) / 1000);
            
            let displayText;
            if (diff < 10) {
                displayText = "Just now";
            } else if (diff < 60) {
                displayText = `${diff} seconds ago`;
            } else if (diff < 3600) {
                displayText = `${Math.floor(diff / 60)} minutes ago`;
            } else {
                displayText = luxon.DateTime.fromJSDate(lastUpdateTime).toFormat('HH:mm:ss');
            }
            
            document.getElementById('lastUpdate').textContent = `Last update: ${displayText}`;
        }

        function checkConnection() {
            if (!isConnected) {
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-times-circle text-danger me-1"></i> Disconnected. Attempting to reconnect...';
                
                // Try to reconnect
                if (mqttClient && !mqttClient.isConnected()) {
                    initMQTT();
                }
            }
        }

        function getStageIndex(stageName) {
            for (let i = 0; i < config.stages.length; i++) {
                if (config.stages[i].name === stageName) {
                    return i;
                }
            }
            return 0;
        }

        function formatUptime(seconds) {
            if (!seconds) return "0s";
            
            const secs = parseInt(seconds);
            const hours = Math.floor(secs / 3600);
            const minutes = Math.floor((secs % 3600) / 60);
            const remainingSeconds = secs % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${remainingSeconds}s`;
            } else {
                return `${remainingSeconds}s`;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+R to refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                forceRefresh();
            }
            
            // Escape to dismiss alarm
            if (e.key === 'Escape') {
                hideAlarm();
            }
        });
    </script>
</body>
</html>
