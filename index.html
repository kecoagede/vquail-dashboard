<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VQuail Smart Controller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        :root {
            /* Color Palette matching TFT display */
            --tft-bg: #0841; /* Dark background */
            --tft-card-bg: #18C3; /* Card background */
            --tft-text: #FFFFFF; /* White text */
            --tft-text-dim: #8C51; /* Dim text */
            --tft-accent: #07FF; /* Cyan accent */
            --tft-success: #07E0; /* Green */
            --tft-warning: #FD20; /* Orange */
            --tft-danger: #F800; /* Red */
            --tft-info: #7D7C; /* Blue */
            
            /* Button colors */
            --btn-normal: #10A2;
            --btn-hover: #18E3;
            --btn-active: #07FF;
            --btn-success: #07E0;
            --btn-danger: #F800;
            --btn-warning: #FD20;
            
            /* Status colors */
            --status-off: #4208;
            --status-on: #07E0;
            --status-alarm: #F800;
            --status-disconnected: #528A;
            
            /* Stage colors */
            --brood1: #F9A6;
            --brood2: #FD20;
            --grower: #2F6B;
            --adult: #4AFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a1929 0%, #1a2b3c 100%);
            color: var(--tft-text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: rgba(24, 195, 195, 0.2);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(7, 255, 255, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 28px;
            color: var(--tft-accent);
        }
        
        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--tft-text);
        }
        
        .logo-text .subtitle {
            font-size: 14px;
            color: var(--tft-text-dim);
            margin-top: 2px;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        .time-display {
            text-align: right;
        }
        
        .time {
            font-size: 20px;
            font-weight: 500;
            color: var(--tft-accent);
        }
        
        .date {
            font-size: 14px;
            color: var(--tft-text-dim);
            margin-top: 2px;
        }
        
        .status-indicators {
            display: flex;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.wifi { background-color: var(--tft-success); }
        .status-dot.wifi.disconnected { background-color: var(--status-disconnected); }
        .status-dot.mqtt { background-color: var(--tft-success); }
        .status-dot.mqtt.disconnected { background-color: var(--status-disconnected); }
        .status-dot.sensor { background-color: var(--tft-success); }
        .status-dot.sensor.disconnected { background-color: var(--status-disconnected); }
        .status-dot.sd { background-color: var(--tft-success); }
        
        .status-label {
            font-size: 11px;
            color: var(--tft-text-dim);
        }
        
        /* Alarm Banner */
        .alarm-banner {
            background: linear-gradient(90deg, var(--tft-warning) 0%, #ff9800 100%);
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        
        .alarm-banner.critical {
            background: linear-gradient(90deg, var(--tft-danger) 0%, #ff4444 100%);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
        }
        
        .alarm-icon {
            font-size: 22px;
            color: white;
        }
        
        .alarm-text {
            flex-grow: 1;
            font-size: 15px;
            font-weight: 500;
            color: white;
        }
        
        .alarm-source {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        /* Navigation */
        .navigation {
            display: flex;
            background: rgba(24, 195, 195, 0.15);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .nav-button {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--tft-text-dim);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-button:hover {
            background: rgba(7, 255, 255, 0.1);
            color: var(--tft-text);
        }
        
        .nav-button.active {
            background: rgba(7, 255, 255, 0.2);
            color: var(--tft-accent);
            font-weight: 600;
        }
        
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: var(--tft-accent);
            border-radius: 2px;
        }
        
        .nav-icon {
            display: block;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        /* Main Content */
        .main-content {
            background: rgba(24, 195, 195, 0.1);
            border-radius: 12px;
            padding: 25px;
            min-height: 500px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(7, 255, 255, 0.05);
        }
        
        /* Card styling */
        .card {
            background: rgba(24, 195, 195, 0.2);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(7, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            font-size: 16px;
            color: var(--tft-text-dim);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Sensor Cards */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .sensor-card {
            position: relative;
            overflow: hidden;
        }
        
        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }
        
        .sensor-card.temp::before { background: var(--tft-success); }
        .sensor-card.hum::before { background: var(--tft-info); }
        .sensor-card.disconnected::before { background: var(--status-disconnected); }
        
        .sensor-value {
            font-size: 42px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .sensor-unit {
            font-size: 24px;
            color: var(--tft-text-dim);
            margin-left: 5px;
        }
        
        .sensor-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .sensor-status.online {
            background: rgba(7, 224, 224, 0.2);
            color: var(--tft-success);
        }
        
        .sensor-status.offline {
            background: rgba(248, 0, 0, 0.2);
            color: var(--tft-danger);
        }
        
        .sensor-status.disconnected {
            background: rgba(82, 138, 138, 0.2);
            color: var(--status-disconnected);
        }
        
        .sensor-raw {
            font-size: 14px;
            color: var(--tft-text-dim);
            margin-top: 10px;
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .status-card {
            text-align: center;
            padding: 15px;
        }
        
        .status-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .status-name {
            font-size: 14px;
            color: var(--tft-text-dim);
            margin-bottom: 8px;
        }
        
        .status-state {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-state.on { color: var(--tft-success); }
        .status-state.off { color: var(--tft-text); }
        .status-state.disconnected { color: var(--status-disconnected); }
        
        .status-controls {
            margin-top: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-normal { background: var(--btn-normal); color: var(--tft-text); }
        .btn-normal:hover { background: var(--btn-hover); }
        
        .btn-success { background: var(--btn-success); color: white; }
        .btn-success:hover { background: #06d0d0; }
        
        .btn-danger { background: var(--btn-danger); color: white; }
        .btn-danger:hover { background: #e60000; }
        
        .btn-warning { background: var(--btn-warning); color: white; }
        .btn-warning:hover { background: #fc9c00; }
        
        .btn-active { background: var(--btn-active); color: white; }
        .btn-active:hover { background: #06e6e6; }
        
        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .control-section {
            margin-bottom: 25px;
        }
        
        .control-title {
            font-size: 18px;
            color: var(--tft-accent);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(7, 255, 255, 0.2);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .control-btn-large {
            padding: 18px;
            font-size: 16px;
        }
        
        .control-quick {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .quick-btn {
            height: 100px;
            font-size: 20px;
            flex-direction: column;
        }
        
        .quick-btn i {
            font-size: 32px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .mode-selector .btn {
            flex: 1;
        }
        
        /* Settings */
        .settings-grid {
            display: grid;
            gap: 25px;
        }
        
        .stage-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stage-btn {
            padding: 15px 5px;
            border: 2px solid transparent;
            background: var(--btn-normal);
        }
        
        .stage-btn.active {
            border-color: white;
        }
        
        .stage-btn.brood1 { background: var(--brood1); }
        .stage-btn.brood2 { background: var(--brood2); }
        .stage-btn.grower { background: var(--grower); }
        .stage-btn.adult { background: var(--adult); }
        
        .calibration-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
        }
        
        .cal-value {
            font-size: 20px;
            font-weight: 600;
        }
        
        .cal-value.temp { color: var(--tft-success); }
        .cal-value.hum { color: var(--tft-info); }
        
        .settings-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }
        
        /* Info Panel */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .info-section {
            margin-bottom: 25px;
        }
        
        .info-detail {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-detail:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: var(--tft-text-dim);
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .info-value.online { color: var(--tft-success); }
        .info-value.offline { color: var(--tft-danger); }
        .info-value.disconnected { color: var(--status-disconnected); }
        
        /* Control Channel Display */
        .control-channel {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
        }
        
        .control-channel.web {
            background: rgba(253, 32, 32, 0.2);
            color: var(--tft-warning);
        }
        
        .control-channel.tft {
            background: rgba(7, 224, 224, 0.2);
            color: var(--tft-success);
        }
        
        .control-channel.auto {
            background: rgba(125, 124, 124, 0.2);
            color: var(--tft-info);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--tft-text-dim);
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .stage-selector {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .settings-actions {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-info {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media (max-width: 480px) {
            .sensor-grid, .status-grid {
                grid-template-columns: 1fr;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .stage-selector {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--tft-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            display: none;
        }
        
        .connection-status.connected {
            background: rgba(7, 224, 224, 0.9);
            color: white;
            display: block;
        }
        
        .connection-status.disconnected {
            background: rgba(248, 0, 0, 0.9);
            color: white;
            display: block;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid var(--tft-success);
        }
        
        .toast.error {
            border-left: 4px solid var(--tft-danger);
        }
        
        .toast.warning {
            border-left: 4px solid var(--tft-warning);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status"></div>
        
        <!-- Toast Notifications -->
        <div id="toast" class="toast"></div>
        
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-dove"></i>
                </div>
                <div class="logo-text">
                    <h1>VQuail Smart Controller</h1>
                    <div class="subtitle">Comprehensive Status Monitoring System</div>
                </div>
            </div>
            <div class="header-info">
                <div class="time-display">
                    <div class="time" id="currentTime">--:--:--</div>
                    <div class="date" id="currentDate">------</div>
                </div>
                <div class="status-indicators">
                    <div class="status-indicator">
                        <div class="status-dot wifi" id="wifiStatus"></div>
                        <div class="status-label">WiFi</div>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot mqtt" id="mqttStatus"></div>
                        <div class="status-label">MQTT</div>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot sensor" id="sensorStatus"></div>
                        <div class="status-label">Sensor</div>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot sd" id="sdStatus"></div>
                        <div class="status-label">SD Card</div>
                    </div>
                </div>
                <div id="controlChannel" class="control-channel auto">AUTO</div>
            </div>
        </header>
        
        <!-- Alarm Banner -->
        <div id="alarmBanner" class="alarm-banner" style="display: none;">
            <div class="alarm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alarm-text" id="alarmText">No alarms</div>
            <div class="alarm-source" id="alarmSource">SYSTEM</div>
        </div>
        
        <!-- Navigation -->
        <nav class="navigation">
            <button class="nav-button active" data-screen="home">
                <i class="fas fa-home nav-icon"></i>
                Home
            </button>
            <button class="nav-button" data-screen="control">
                <i class="fas fa-sliders-h nav-icon"></i>
                Control
            </button>
            <button class="nav-button" data-screen="settings">
                <i class="fas fa-cog nav-icon"></i>
                Settings
            </button>
            <button class="nav-button" data-screen="info">
                <i class="fas fa-info-circle nav-icon"></i>
                Info
            </button>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen">
                <!-- Sensor Cards -->
                <div class="sensor-grid">
                    <div class="card sensor-card temp">
                        <div class="card-title">
                            <span>Temperature</span>
                            <div class="sensor-status online" id="tempStatus">ONLINE</div>
                        </div>
                        <div class="sensor-value">
                            <span id="temperature">--.-</span>
                            <span class="sensor-unit">°C</span>
                        </div>
                        <div class="sensor-raw">
                            Raw: <span id="rawTemp">--.-</span>°C | Offset: <span id="tempOffset">+0.0</span>°C
                        </div>
                        <div class="card-title">
                            <small id="tempTime">--:--:--</small>
                            <small>Stage: <span id="stageRange">35-37°C</span></small>
                        </div>
                    </div>
                    
                    <div class="card sensor-card hum">
                        <div class="card-title">
                            <span>Humidity</span>
                            <div class="sensor-status online" id="humStatus">ONLINE</div>
                        </div>
                        <div class="sensor-value">
                            <span id="humidity">--.-</span>
                            <span class="sensor-unit">%</span>
                        </div>
                        <div class="sensor-raw">
                            Raw: <span id="rawHum">--.-</span>% | Offset: <span id="humOffset">+0.0</span>%
                        </div>
                        <div class="card-title">
                            <small id="humTime">--:--:--</small>
                            <small>Stage: <span id="humRange">60-70%</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Status Cards -->
                <div class="status-grid">
                    <div class="card status-card">
                        <div class="status-icon">
                            <i class="fas fa-wind"></i>
                        </div>
                        <div class="status-name">FAN</div>
                        <div class="status-state on" id="fanState">ON</div>
                        <div class="status-controls">
                            <button class="btn btn-small btn-success" id="toggleFan">
                                <i class="fas fa-power-off"></i> Toggle
                            </button>
                        </div>
                    </div>
                    
                    <div class="card status-card">
                        <div class="status-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="status-name">HEAT LAMP</div>
                        <div class="status-state off" id="heatState">OFF</div>
                        <div class="status-controls">
                            <button class="btn btn-small btn-warning" id="toggleHeat">
                                <i class="fas fa-power-off"></i> Toggle
                            </button>
                        </div>
                    </div>
                    
                    <div class="card status-card">
                        <div class="status-icon">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div class="status-name">WiFi</div>
                        <div class="status-state on" id="wifiState">CONNECTED</div>
                        <div class="status-value" id="wifiRSSI">-65 dBm</div>
                    </div>
                    
                    <div class="card status-card">
                        <div class="status-icon">
                            <i class="fas fa-broadcast-tower"></i>
                        </div>
                        <div class="status-name">MQTT</div>
                        <div class="status-state on" id="mqttState">CONNECTED</div>
                        <div class="status-value" id="mqttStatusText">Active</div>
                    </div>
                </div>
                
                <!-- System Info -->
                <div class="card">
                    <div class="card-title">
                        System Status
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 18px; color: var(--tft-accent);">
                                <span id="currentStage">Brood W1</span> | <span id="ageDays">0</span> days
                            </div>
                            <div style="font-size: 14px; color: var(--tft-text-dim); margin-top: 8px;">
                                Calibration: T: <span id="displayTempOffset">+0.0</span>°C H: <span id="displayHumOffset">+0.0</span>%
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; color: var(--tft-text-dim);">Control Channel</div>
                            <div id="homeControlChannel" class="control-channel auto">AUTO</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 14px; color: var(--tft-text-dim);">
                        <i class="fas fa-clock"></i> Last update: <span id="lastUpdate">--:--:--</span>
                    </div>
                </div>
            </div>
            
            <!-- Control Screen -->
            <div id="controlScreen" class="screen" style="display: none;">
                <div class="control-panel">
                    <div class="control-section">
                        <h2 class="control-title">Device Control</h2>
                        
                        <div class="control-grid">
                            <button class="btn control-btn-large btn-success" id="fanOn">
                                <i class="fas fa-wind"></i> FAN ON
                            </button>
                            <button class="btn control-btn-large btn-danger" id="fanOff">
                                <i class="fas fa-wind"></i> FAN OFF
                            </button>
                            <button class="btn control-btn-large btn-warning" id="heatOn">
                                <i class="fas fa-fire"></i> HEAT ON
                            </button>
                            <button class="btn control-btn-large btn-danger" id="heatOff">
                                <i class="fas fa-fire"></i> HEAT OFF
                            </button>
                        </div>
                        
                        <div class="mode-selector">
                            <button class="btn btn-active" id="autoMode">
                                <i class="fas fa-robot"></i> AUTO MODE
                            </button>
                            <button class="btn btn-normal" id="manualMode">
                                <i class="fas fa-hand-paper"></i> MANUAL MODE
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h2 class="control-title">Quick Actions</h2>
                        
                        <div class="control-quick">
                            <button class="btn quick-btn btn-success" id="bothOn">
                                <i class="fas fa-power-off"></i>
                                BOTH ON
                            </button>
                            <button class="btn quick-btn btn-danger" id="bothOff">
                                <i class="fas fa-power-off"></i>
                                BOTH OFF
                            </button>
                            <button class="btn quick-btn btn-active" id="forcePublish">
                                <i class="fas fa-cloud-upload-alt"></i>
                                PUBLISH
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 30px;">
                    <div class="card-title">
                        Current Status
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="font-size: 14px; color: var(--tft-text-dim);">Temperature</div>
                            <div style="font-size: 28px; font-weight: 700;">
                                <span id="controlTemp">--.-</span>°C
                            </div>
                            <div style="font-size: 12px; color: var(--tft-text-dim); margin-top: 5px;">
                                <span id="controlTempStatus">Sensor online</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: var(--tft-text-dim);">Humidity</div>
                            <div style="font-size: 28px; font-weight: 700;">
                                <span id="controlHum">--.-</span>%
                            </div>
                            <div style="font-size: 12px; color: var(--tft-text-dim); margin-top: 5px;">
                                <span id="controlHumStatus">Sensor online</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="font-size: 14px; color: var(--tft-text-dim);">Control Information</div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div>
                                <div style="font-size: 12px; color: var(--tft-text-dim);">Channel</div>
                                <div id="controlChannelInfo" class="control-channel auto" style="margin-left: 0;">AUTO</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--tft-text-dim);">Last Source</div>
                                <div style="font-size: 16px; font-weight: 500; color: var(--tft-accent);" id="lastControlSource">SYSTEM</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--tft-text-dim);">Override</div>
                                <div style="font-size: 16px; font-weight: 500; color: var(--tft-warning);" id="overrideStatus">NO</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Screen -->
            <div id="settingsScreen" class="screen" style="display: none;">
                <div class="settings-grid">
                    <div class="card">
                        <div class="card-title">
                            Life Stage Configuration
                        </div>
                        <div style="font-size: 14px; color: var(--tft-text-dim); margin-bottom: 10px;">
                            Current: <span id="currentStageDisplay">Brood W1</span> (<span id="currentStageDays">0-7</span> days)
                        </div>
                        
                        <div class="stage-selector">
                            <button class="stage-btn brood1" data-stage="0">Brood W1</button>
                            <button class="stage-btn brood2" data-stage="1">Brood W2</button>
                            <button class="stage-btn grower" data-stage="2">Grower</button>
                            <button class="stage-btn adult" data-stage="3">Adult</button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <div style="font-size: 14px; color: var(--tft-text-dim); margin-bottom: 10px;">Age (days)</div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button class="btn btn-danger" id="ageDown">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <div style="font-size: 24px; font-weight: 700; color: var(--tft-accent);" id="ageDisplay">0</div>
                                <button class="btn btn-success" id="ageUp">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">
                            Sensor Calibration
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <div style="font-size: 16px; color: var(--tft-success); margin-bottom: 10px;">Temperature Calibration</div>
                            <div class="calibration-controls">
                                <div class="cal-value temp" id="calTempValue">+0.0°C</div>
                                <button class="btn btn-danger" id="tempCalDown">
                                    <i class="fas fa-minus"></i> -0.5°C
                                </button>
                                <button class="btn btn-success" id="tempCalUp">
                                    <i class="fas fa-plus"></i> +0.5°C
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 16px; color: var(--tft-info); margin-bottom: 10px;">Humidity Calibration</div>
                            <div class="calibration-controls">
                                <div class="cal-value hum" id="calHumValue">+0.0%</div>
                                <button class="btn btn-danger" id="humCalDown">
                                    <i class="fas fa-minus"></i> -0.5%
                                </button>
                                <button class="btn btn-success" id="humCalUp">
                                    <i class="fas fa-plus"></i> +0.5%
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button class="btn btn-success" id="saveSettings">
                            <i class="fas fa-save"></i> SAVE SETTINGS
                        </button>
                        <button class="btn btn-warning" id="rebootSystem">
                            <i class="fas fa-redo"></i> REBOOT SYSTEM
                        </button>
                        <button class="btn btn-danger" id="resetCalibration">
                            <i class="fas fa-undo"></i> RESET CALIBRATION
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Info Screen -->
            <div id="infoScreen" class="screen" style="display: none;">
                <div class="info-grid">
                    <div class="card">
                        <div class="card-title">
                            <i class="fas fa-network-wired"></i> Network Status
                        </div>
                        <div class="info-section">
                            <div class="info-detail">
                                <span class="info-label">WiFi Status</span>
                                <span class="info-value online" id="infoWifi">Connected</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">IP Address</span>
                                <span class="info-value" id="infoIP">192.168.1.100</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">RSSI</span>
                                <span class="info-value" id="infoRSSI">-65 dBm</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">MQTT Status</span>
                                <span class="info-value online" id="infoMQTT">Connected</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">NTP Sync</span>
                                <span class="info-value online" id="infoNTP">Synchronized</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">
                            <i class="fas fa-microchip"></i> Hardware Status
                        </div>
                        <div class="info-section">
                            <div class="info-detail">
                                <span class="info-label">SD Card</span>
                                <span class="info-value online" id="infoSD">Available</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">Sensor</span>
                                <span class="info-value online" id="infoSensor">Online</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">TFT Display</span>
                                <span class="info-value online" id="infoTFT">OK</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">Touch Screen</span>
                                <span class="info-value online" id="infoTouch">OK</span>
                            </div>
                            <div class="info-detail">
                                <span class="info-label">ESP32 Status</span>
                                <span class="info-value online" id="infoESP32">OK</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <i class="fas fa-info-circle"></i> System Information
                    </div>
                    <div class="info-section">
                        <div class="info-detail">
                            <span class="info-label">Version</span>
                            <span class="info-value" id="infoVersion">VQUAIL_S3_TFT_V8</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Uptime</span>
                            <span class="info-value" id="infoUptime">0h 0m</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Control Channel</span>
                            <span class="info-value" id="infoChannel">AUTO</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Temperature Calibration</span>
                            <span class="info-value" id="infoCalTemp">+0.0°C</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Humidity Calibration</span>
                            <span class="info-value" id="infoCalHum">+0.0%</span>
                        </div>
                    </div>
                </div>
                
                <div id="infoAlarmCard" class="card" style="margin-top: 20px; display: none;">
                    <div class="card-title" style="color: var(--tft-danger);">
                        <i class="fas fa-exclamation-triangle"></i> Active Alarm
                    </div>
                    <div class="info-section">
                        <div class="info-detail">
                            <span class="info-label">Message</span>
                            <span class="info-value" id="infoAlarmMessage">No alarms</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Source</span>
                            <span class="info-value" id="infoAlarmSource">SYSTEM</span>
                        </div>
                        <div class="info-detail">
                            <span class="info-label">Critical</span>
                            <span class="info-value" id="infoAlarmCritical">NO</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer">
            <p>VQuail Smart Controller &copy; 2024 | ESP32-S3 with TFT Display | Real-time Monitoring & Control</p>
            <p style="margin-top: 10px; font-size: 12px;">
                <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="refreshStatus">Connected</span> | 
                <i class="fas fa-database"></i> Last update: <span id="footerLastUpdate">--:--:--</span>
            </p>
        </footer>
    </div>

    <script>
        // MQTT Configuration
        const MQTT_CONFIG = {
            host: '514ee1c5407448169298c78647ad26b9.s1.eu.hivemq.cloud',
            port: 8883,
            username: 'vquail',
            password: 'Vquail12345',
            clientId: 'web-client-' + Math.random().toString(16).substr(2, 8),
            useSSL: true
        };

        // State variables
        let state = {
            // Sensor data
            temperature: null,
            humidity: null,
            rawTemp: null,
            rawHum: null,
            sensorOnline: false,
            sensorDisconnected: false,
            
            // Device state
            fan: false,
            heat: false,
            autoMode: true,
            override: false,
            lastControlSource: 'system',
            
            // Network status
            wifi: false,
            wifiDisconnected: false,
            mqtt: false,
            mqttDisconnected: false,
            ntp: false,
            wifiRSSI: 0,
            wifiIP: '',
            
            // System status
            sdCard: false,
            tft: false,
            touch: false,
            esp32: false,
            
            // Stage and calibration
            currentStage: 0,
            ageDays: 0,
            tempOffset: 0.0,
            humOffset: 0.0,
            
            // Alarm state
            alarmActive: false,
            alarmMessage: '',
            alarmSource: '',
            alarmCritical: false,
            
            // Control channel
            controlChannel: 'AUTO',
            
            // Time
            currentTime: '--:--:--',
            currentDate: '------',
            lastUpdate: '--:--:--',
            uptime: '0h 0m'
        };

        // MQTT Client
        let mqttClient = null;
        let isConnected = false;
        let reconnectInterval = null;

        // Stage configuration
        const stages = [
            { name: 'Brood W1', minAge: 0, maxAge: 7, tempMin: 35.0, tempMax: 37.0, humMin: 60.0, humMax: 70.0, color: '#F9A6' },
            { name: 'Brood W2', minAge: 8, maxAge: 14, tempMin: 32.0, tempMax: 35.0, humMin: 60.0, humMax: 70.0, color: '#FD20' },
            { name: 'Grower', minAge: 15, maxAge: 42, tempMin: 24.0, tempMax: 28.0, humMin: 55.0, humMax: 65.0, color: '#2F6B' },
            { name: 'Adult', minAge: 43, maxAge: 999, tempMin: 20.0, tempMax: 24.0, humMin: 50.0, humMax: 60.0, color: '#4AFF' }
        ];

        // DOM Elements
        const elements = {
            // Time displays
            currentTime: document.getElementById('currentTime'),
            currentDate: document.getElementById('currentDate'),
            lastUpdate: document.getElementById('lastUpdate'),
            footerLastUpdate: document.getElementById('footerLastUpdate'),
            
            // Status indicators
            wifiStatus: document.getElementById('wifiStatus'),
            mqttStatus: document.getElementById('mqttStatus'),
            sensorStatus: document.getElementById('sensorStatus'),
            sdStatus: document.getElementById('sdStatus'),
            
            // Control channel
            controlChannel: document.getElementById('controlChannel'),
            homeControlChannel: document.getElementById('homeControlChannel'),
            controlChannelInfo: document.getElementById('controlChannelInfo'),
            
            // Alarm
            alarmBanner: document.getElementById('alarmBanner'),
            alarmText: document.getElementById('alarmText'),
            alarmSource: document.getElementById('alarmSource'),
            
            // Sensor displays
            temperature: document.getElementById('temperature'),
            humidity: document.getElementById('humidity'),
            rawTemp: document.getElementById('rawTemp'),
            rawHum: document.getElementById('rawHum'),
            tempOffset: document.getElementById('tempOffset'),
            humOffset: document.getElementById('humOffset'),
            tempStatus: document.getElementById('tempStatus'),
            humStatus: document.getElementById('humStatus'),
            tempTime: document.getElementById('tempTime'),
            humTime: document.getElementById('humTime'),
            stageRange: document.getElementById('stageRange'),
            humRange: document.getElementById('humRange'),
            
            // Control screen
            controlTemp: document.getElementById('controlTemp'),
            controlHum: document.getElementById('controlHum'),
            controlTempStatus: document.getElementById('controlTempStatus'),
            controlHumStatus: document.getElementById('controlHumStatus'),
            lastControlSource: document.getElementById('lastControlSource'),
            overrideStatus: document.getElementById('overrideStatus'),
            
            // Device states
            fanState: document.getElementById('fanState'),
            heatState: document.getElementById('heatState'),
            wifiState: document.getElementById('wifiState'),
            mqttState: document.getElementById('mqttState'),
            wifiRSSI: document.getElementById('wifiRSSI'),
            mqttStatusText: document.getElementById('mqttStatusText'),
            
            // Stage and age
            currentStage: document.getElementById('currentStage'),
            ageDays: document.getElementById('ageDays'),
            displayTempOffset: document.getElementById('displayTempOffset'),
            displayHumOffset: document.getElementById('displayHumOffset'),
            
            // Info screen
            infoWifi: document.getElementById('infoWifi'),
            infoIP: document.getElementById('infoIP'),
            infoRSSI: document.getElementById('infoRSSI'),
            infoMQTT: document.getElementById('infoMQTT'),
            infoNTP: document.getElementById('infoNTP'),
            infoSD: document.getElementById('infoSD'),
            infoSensor: document.getElementById('infoSensor'),
            infoTFT: document.getElementById('infoTFT'),
            infoTouch: document.getElementById('infoTouch'),
            infoESP32: document.getElementById('infoESP32'),
            infoVersion: document.getElementById('infoVersion'),
            infoUptime: document.getElementById('infoUptime'),
            infoChannel: document.getElementById('infoChannel'),
            infoCalTemp: document.getElementById('infoCalTemp'),
            infoCalHum: document.getElementById('infoCalHum'),
            infoAlarmCard: document.getElementById('infoAlarmCard'),
            infoAlarmMessage: document.getElementById('infoAlarmMessage'),
            infoAlarmSource: document.getElementById('infoAlarmSource'),
            infoAlarmCritical: document.getElementById('infoAlarmCritical'),
            
            // Settings screen
            currentStageDisplay: document.getElementById('currentStageDisplay'),
            currentStageDays: document.getElementById('currentStageDays'),
            ageDisplay: document.getElementById('ageDisplay'),
            calTempValue: document.getElementById('calTempValue'),
            calHumValue: document.getElementById('calHumValue'),
            
            // Connection status
            connectionStatus: document.getElementById('connectionStatus'),
            refreshStatus: document.getElementById('refreshStatus'),
            
            // Screens
            screens: {
                home: document.getElementById('homeScreen'),
                control: document.getElementById('controlScreen'),
                settings: document.getElementById('settingsScreen'),
                info: document.getElementById('infoScreen')
            },
            
            // Toast
            toast: document.getElementById('toast')
        };

        // Navigation
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                const screen = button.getAttribute('data-screen');
                switchScreen(screen);
                
                // Update active button
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            });
        });

        function switchScreen(screen) {
            // Hide all screens
            Object.values(elements.screens).forEach(s => {
                s.style.display = 'none';
            });
            
            // Show selected screen
            elements.screens[screen].style.display = 'block';
            
            // If switching to settings, update the display
            if (screen === 'settings') {
                updateSettingsDisplay();
            }
        }

        // Initialize MQTT connection
        function initMQTT() {
            try {
                // Create MQTT client
                mqttClient = new Paho.MQTT.Client(
                    MQTT_CONFIG.host,
                    MQTT_CONFIG.port,
                    MQTT_CONFIG.clientId
                );

                // Set callback handlers
                mqttClient.onConnectionLost = onConnectionLost;
                mqttClient.onMessageArrived = onMessageArrived;

                // Connect the client
                const connectOptions = {
                    userName: MQTT_CONFIG.username,
                    password: MQTT_CONFIG.password,
                    useSSL: MQTT_CONFIG.useSSL,
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    reconnect: true,
                    keepAliveInterval: 30,
                    cleanSession: true
                };

                mqttClient.connect(connectOptions);
                
                showConnectionStatus('Connecting to MQTT...', 'warning');
            } catch (error) {
                console.error('MQTT initialization error:', error);
                showConnectionStatus('Connection error', 'error');
                startReconnection();
            }
        }

        function onConnect() {
            console.log('MQTT Connected');
            isConnected = true;
            
            // Subscribe to topics
            mqttClient.subscribe('vquail/status/device');
            mqttClient.subscribe('vquail/status/sensors');
            mqttClient.subscribe('vquail/control/source');
            mqttClient.subscribe('vquail/calibration/current');
            mqttClient.subscribe('vquail/status/system');
            
            showConnectionStatus('Connected to MQTT', 'success');
            updateConnectionStatus();
            
            // Request full status update
            setTimeout(() => {
                requestFullStatus();
            }, 1000);
        }

        function onConnectFailure(error) {
            console.error('MQTT Connection failed:', error);
            showConnectionStatus('Connection failed', 'error');
            isConnected = false;
            updateConnectionStatus();
            startReconnection();
        }

        function onConnectionLost(response) {
            console.log('MQTT Connection lost:', response);
            showConnectionStatus('Connection lost', 'error');
            isConnected = false;
            updateConnectionStatus();
            startReconnection();
        }

        function onMessageArrived(message) {
            try {
                const topic = message.destinationName;
                const payload = JSON.parse(message.payloadString);
                
                console.log('Received MQTT message:', topic, payload);
                
                // Update state based on topic
                switch (topic) {
                    case 'vquail/status/device':
                        updateDeviceState(payload);
                        break;
                    case 'vquail/status/sensors':
                        updateSensorData(payload);
                        break;
                    case 'vquail/control/source':
                        updateControlSource(payload);
                        break;
                    case 'vquail/calibration/current':
                        updateCalibration(payload);
                        break;
                    case 'vquail/status/system':
                        updateSystemStatus(payload);
                        break;
                }
                
                // Update UI
                updateUI();
                
            } catch (error) {
                console.error('Error processing MQTT message:', error);
            }
        }

        function startReconnection() {
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
            
            reconnectInterval = setInterval(() => {
                if (!isConnected) {
                    console.log('Attempting to reconnect...');
                    initMQTT();
                }
            }, 5000);
        }

        function updateDeviceState(data) {
            // Update sensor data
            if (data.temp !== undefined) state.temperature = data.temp;
            if (data.hum !== undefined) state.humidity = data.hum;
            if (data.sensor_online !== undefined) state.sensorOnline = data.sensor_online;
            if (data.sensor_disconnected !== undefined) state.sensorDisconnected = data.sensor_disconnected;
            
            // Update device state
            if (data.fan !== undefined) state.fan = data.fan;
            if (data.heat !== undefined) state.heat = data.heat;
            if (data.auto !== undefined) state.autoMode = data.auto;
            if (data.override !== undefined) state.override = data.override;
            if (data.last_control_source !== undefined) state.lastControlSource = data.last_control_source;
            
            // Update stage and age
            if (data.stage !== undefined) {
                const stageIndex = stages.findIndex(s => s.name === data.stage);
                if (stageIndex !== -1) state.currentStage = stageIndex;
            }
            if (data.age !== undefined) state.ageDays = data.age;
            
            // Update calibration
            if (data.temp_offset !== undefined) state.tempOffset = data.temp_offset;
            if (data.hum_offset !== undefined) state.humOffset = data.hum_offset;
            
            // Update control channel
            if (data.control_channel !== undefined) state.controlChannel = data.control_channel;
            
            // Update alarm state
            if (data.alarm_active !== undefined) state.alarmActive = data.alarm_active;
            if (data.alarm_message !== undefined) state.alarmMessage = data.alarm_message;
            if (data.alarm_source !== undefined) state.alarmSource = data.alarm_source;
            if (data.alarm_critical !== undefined) state.alarmCritical = data.alarm_critical;
            
            // Update time
            if (data.time !== undefined) state.currentTime = data.time;
            if (data.date !== undefined) state.currentDate = data.date;
            if (data.uptime !== undefined) state.uptime = formatUptime(parseInt(data.uptime));
            
            state.lastUpdate = new Date().toLocaleTimeString();
        }

        function updateSensorData(data) {
            if (data.temp !== undefined) state.temperature = data.temp;
            if (data.hum !== undefined) state.humidity = data.hum;
            if (data.raw_temp !== undefined) state.rawTemp = data.raw_temp;
            if (data.raw_hum !== undefined) state.rawHum = data.raw_hum;
            if (data.sensor_online !== undefined) state.sensorOnline = data.sensor_online;
            if (data.sensor_disconnected !== undefined) state.sensorDisconnected = data.sensor_disconnected;
            if (data.temp_offset !== undefined) state.tempOffset = data.temp_offset;
            if (data.hum_offset !== undefined) state.humOffset = data.hum_offset;
            
            state.lastUpdate = new Date().toLocaleTimeString();
        }

        function updateControlSource(data) {
            if (data.channel !== undefined) state.controlChannel = data.channel;
            if (data.source !== undefined) state.lastControlSource = data.source;
            if (data.auto_mode !== undefined) state.autoMode = data.auto_mode;
            if (data.override !== undefined) state.override = data.override;
        }

        function updateCalibration(data) {
            if (data.temp_offset !== undefined) state.tempOffset = data.temp_offset;
            if (data.hum_offset !== undefined) state.humOffset = data.hum_offset;
        }

        function updateSystemStatus(data) {
            // Network status
            if (data.wifi !== undefined) state.wifi = data.wifi;
            if (data.wifi_disconnected !== undefined) state.wifiDisconnected = data.wifi_disconnected;
            if (data.mqtt !== undefined) state.mqtt = data.mqtt;
            if (data.mqtt_disconnected !== undefined) state.mqttDisconnected = data.mqtt_disconnected;
            if (data.ntp !== undefined) state.ntp = data.ntp;
            
            // Hardware status
            if (data.sd_card !== undefined) state.sdCard = data.sd_card;
            if (data.dht !== undefined) state.sensorOnline = data.dht;
            if (data.tft !== undefined) state.tft = data.tft;
            if (data.touch !== undefined) state.touch = data.touch;
            if (data.esp32 !== undefined) state.esp32 = data.esp32;
            
            // Additional info
            if (data.wifi_rssi !== undefined) state.wifiRSSI = data.wifi_rssi;
            if (data.wifi_ip !== undefined) state.wifiIP = data.wifi_ip;
        }

        function updateUI() {
            // Update time displays
            elements.currentTime.textContent = state.currentTime;
            elements.currentDate.textContent = state.currentDate;
            elements.lastUpdate.textContent = state.lastUpdate;
            elements.footerLastUpdate.textContent = state.lastUpdate;
            
            // Update status indicators
            updateStatusIndicators();
            
            // Update control channel
            updateControlChannelDisplay();
            
            // Update alarm banner
            updateAlarmBanner();
            
            // Update sensor displays
            updateSensorDisplays();
            
            // Update device states
            updateDeviceDisplays();
            
            // Update stage and calibration
            updateStageDisplay();
            
            // Update info screen
            updateInfoScreen();
        }

        function updateStatusIndicators() {
            // WiFi status
            if (state.wifiDisconnected) {
                elements.wifiStatus.className = 'status-dot wifi disconnected';
                elements.wifiState.textContent = 'DISCONNECTED';
                elements.wifiState.className = 'status-state disconnected';
            } else {
                elements.wifiStatus.className = state.wifi ? 'status-dot wifi' : 'status-dot wifi disconnected';
                elements.wifiState.textContent = state.wifi ? 'CONNECTED' : 'DISCONNECTED';
                elements.wifiState.className = state.wifi ? 'status-state on' : 'status-state disconnected';
            }
            
            // MQTT status
            if (state.mqttDisconnected) {
                elements.mqttStatus.className = 'status-dot mqtt disconnected';
                elements.mqttState.textContent = 'DISCONNECTED';
                elements.mqttStatusText.textContent = 'Disconnected';
            } else {
                elements.mqttStatus.className = state.mqtt ? 'status-dot mqtt' : 'status-dot mqtt disconnected';
                elements.mqttState.textContent = state.mqtt ? 'CONNECTED' : 'DISCONNECTED';
                elements.mqttStatusText.textContent = state.mqtt ? 'Active' : 'Inactive';
            }
            
            // Sensor status
            if (state.sensorDisconnected) {
                elements.sensorStatus.className = 'sensor-status disconnected';
                elements.sensorStatus.textContent = 'DISCONNECTED';
                elements.tempStatus.className = 'sensor-status disconnected';
                elements.tempStatus.textContent = 'DISCONNECTED';
                elements.humStatus.className = 'sensor-status disconnected';
                elements.humStatus.textContent = 'DISCONNECTED';
            } else {
                elements.sensorStatus.className = state.sensorOnline ? 'sensor-status online' : 'sensor-status offline';
                elements.sensorStatus.textContent = state.sensorOnline ? 'ONLINE' : 'OFFLINE';
                elements.tempStatus.className = state.sensorOnline ? 'sensor-status online' : 'sensor-status offline';
                elements.tempStatus.textContent = state.sensorOnline ? 'ONLINE' : 'OFFLINE';
                elements.humStatus.className = state.sensorOnline ? 'sensor-status online' : 'sensor-status offline';
                elements.humStatus.textContent = state.sensorOnline ? 'ONLINE' : 'OFFLINE';
            }
            
            // SD Card status
            elements.sdStatus.className = state.sdCard ? 'status-dot sd' : 'status-dot sd disconnected';
            
            // WiFi RSSI
            elements.wifiRSSI.textContent = state.wifiRSSI + ' dBm';
        }

        function updateControlChannelDisplay() {
            const channel = state.controlChannel.toUpperCase();
            elements.controlChannel.textContent = channel;
            elements.controlChannel.className = `control-channel ${channel.toLowerCase()}`;
            
            elements.homeControlChannel.textContent = channel;
            elements.homeControlChannel.className = `control-channel ${channel.toLowerCase()}`;
            
            elements.controlChannelInfo.textContent = channel;
            elements.controlChannelInfo.className = `control-channel ${channel.toLowerCase()}`;
            
            elements.infoChannel.textContent = channel;
        }

        function updateAlarmBanner() {
            if (state.alarmActive) {
                elements.alarmBanner.style.display = 'flex';
                elements.alarmText.textContent = state.alarmMessage;
                elements.alarmSource.textContent = state.alarmSource.toUpperCase();
                
                if (state.alarmCritical) {
                    elements.alarmBanner.className = 'alarm-banner critical';
                } else {
                    elements.alarmBanner.className = 'alarm-banner';
                }
                
                // Show in info screen
                elements.infoAlarmCard.style.display = 'block';
                elements.infoAlarmMessage.textContent = state.alarmMessage;
                elements.infoAlarmSource.textContent = state.alarmSource;
                elements.infoAlarmCritical.textContent = state.alarmCritical ? 'YES' : 'NO';
            } else {
                elements.alarmBanner.style.display = 'none';
                elements.infoAlarmCard.style.display = 'none';
            }
        }

        function updateSensorDisplays() {
            // Temperature
            if (state.temperature !== null && !isNaN(state.temperature)) {
                elements.temperature.textContent = state.temperature.toFixed(1);
                elements.controlTemp.textContent = state.temperature.toFixed(1);
            } else {
                elements.temperature.textContent = '--.-';
                elements.controlTemp.textContent = '--.-';
            }
            
            // Humidity
            if (state.humidity !== null && !isNaN(state.humidity)) {
                elements.humidity.textContent = state.humidity.toFixed(1);
                elements.controlHum.textContent = state.humidity.toFixed(1);
            } else {
                elements.humidity.textContent = '--.-';
                elements.controlHum.textContent = '--.-';
            }
            
            // Raw values
            elements.rawTemp.textContent = state.rawTemp !== null ? state.rawTemp.toFixed(1) : '--.-';
            elements.rawHum.textContent = state.rawHum !== null ? state.rawHum.toFixed(1) : '--.-';
            
            // Offsets
            elements.tempOffset.textContent = formatOffset(state.tempOffset);
            elements.humOffset.textContent = formatOffset(state.humOffset);
            elements.displayTempOffset.textContent = formatOffset(state.tempOffset);
            elements.displayHumOffset.textContent = formatOffset(state.humOffset);
            elements.calTempValue.textContent = formatOffset(state.tempOffset) + '°C';
            elements.calHumValue.textContent = formatOffset(state.humOffset) + '%';
            elements.infoCalTemp.textContent = formatOffset(state.tempOffset) + '°C';
            elements.infoCalHum.textContent = formatOffset(state.humOffset) + '%';
            
            // Time stamps
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            elements.tempTime.textContent = timeStr;
            elements.humTime.textContent = timeStr;
            
            // Stage ranges
            const stage = stages[state.currentStage];
            if (stage) {
                elements.stageRange.textContent = `${stage.tempMin}-${stage.tempMax}°C`;
                elements.humRange.textContent = `${stage.humMin}-${stage.humMax}%`;
            }
            
            // Control screen sensor status
            if (state.sensorDisconnected) {
                elements.controlTempStatus.textContent = 'Sensor disconnected';
                elements.controlTempStatus.style.color = 'var(--status-disconnected)';
                elements.controlHumStatus.textContent = 'Sensor disconnected';
                elements.controlHumStatus.style.color = 'var(--status-disconnected)';
            } else if (!state.sensorOnline) {
                elements.controlTempStatus.textContent = 'Sensor offline';
                elements.controlTempStatus.style.color = 'var(--tft-danger)';
                elements.controlHumStatus.textContent = 'Sensor offline';
                elements.controlHumStatus.style.color = 'var(--tft-danger)';
            } else {
                elements.controlTempStatus.textContent = 'Sensor online';
                elements.controlTempStatus.style.color = 'var(--tft-success)';
                elements.controlHumStatus.textContent = 'Sensor online';
                elements.controlHumStatus.style.color = 'var(--tft-success)';
            }
        }

        function updateDeviceDisplays() {
            // Fan state
            elements.fanState.textContent = state.fan ? 'ON' : 'OFF';
            elements.fanState.className = state.fan ? 'status-state on' : 'status-state off';
            
            // Heat state
            elements.heatState.textContent = state.heat ? 'ON' : 'OFF';
            elements.heatState.className = state.heat ? 'status-state on' : 'status-state off';
            
            // Control source and override
            elements.lastControlSource.textContent = state.lastControlSource.toUpperCase();
            elements.overrideStatus.textContent = state.override ? 'YES' : 'NO';
            elements.overrideStatus.style.color = state.override ? 'var(--tft-warning)' : 'var(--tft-success)';
            
            // Mode buttons
            const autoBtn = document.getElementById('autoMode');
            const manualBtn = document.getElementById('manualMode');
            
            if (state.autoMode) {
                autoBtn.className = 'btn btn-active';
                manualBtn.className = 'btn btn-normal';
            } else {
                autoBtn.className = 'btn btn-normal';
                manualBtn.className = 'btn btn-active';
            }
        }

        function updateStageDisplay() {
            const stage = stages[state.currentStage];
            if (stage) {
                elements.currentStage.textContent = stage.name;
                elements.currentStageDisplay.textContent = stage.name;
                elements.currentStageDays.textContent = `${stage.minAge}-${stage.maxAge}`;
                elements.ageDays.textContent = state.ageDays;
                elements.ageDisplay.textContent = state.ageDays;
                
                // Update stage buttons
                document.querySelectorAll('.stage-btn').forEach((btn, index) => {
                    if (index === state.currentStage) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }

        function updateSettingsDisplay() {
            // This is called when switching to settings screen
            updateStageDisplay();
            
            // Update calibration values
            elements.calTempValue.textContent = formatOffset(state.tempOffset) + '°C';
            elements.calHumValue.textContent = formatOffset(state.humOffset) + '%';
        }

        function updateInfoScreen() {
            // Network info
            elements.infoWifi.textContent = state.wifi ? 'Connected' : 'Disconnected';
            elements.infoWifi.className = state.wifi ? 'info-value online' : 'info-value offline';
            
            elements.infoIP.textContent = state.wifiIP || '--.--.--.--';
            elements.infoRSSI.textContent = state.wifiRSSI + ' dBm';
            
            elements.infoMQTT.textContent = state.mqtt ? 'Connected' : 'Disconnected';
            elements.infoMQTT.className = state.mqtt ? 'info-value online' : 'info-value offline';
            
            elements.infoNTP.textContent = state.ntp ? 'Synchronized' : 'Not synchronized';
            elements.infoNTP.className = state.ntp ? 'info-value online' : 'info-value offline';
            
            // Hardware info
            elements.infoSD.textContent = state.sdCard ? 'Available' : 'Not found';
            elements.infoSD.className = state.sdCard ? 'info-value online' : 'info-value offline';
            
            elements.infoSensor.textContent = state.sensorOnline ? 'Online' : 'Offline';
            elements.infoSensor.className = state.sensorOnline ? 'info-value online' : 'info-value offline';
            
            elements.infoTFT.textContent = state.tft ? 'OK' : 'ERROR';
            elements.infoTFT.className = state.tft ? 'info-value online' : 'info-value offline';
            
            elements.infoTouch.textContent = state.touch ? 'OK' : 'ERROR';
            elements.infoTouch.className = state.touch ? 'info-value online' : 'info-value offline';
            
            elements.infoESP32.textContent = state.esp32 ? 'OK' : 'ERROR';
            elements.infoESP32.className = state.esp32 ? 'info-value online' : 'info-value offline';
            
            // System info
            elements.infoVersion.textContent = 'VQUAIL_S3_TFT_V8_MANUAL_MODE_FIX';
            elements.infoUptime.textContent = state.uptime;
        }

        function updateConnectionStatus() {
            if (isConnected) {
                elements.refreshStatus.textContent = 'Connected';
                elements.refreshStatus.style.color = 'var(--tft-success)';
            } else {
                elements.refreshStatus.textContent = 'Disconnected';
                elements.refreshStatus.style.color = 'var(--tft-danger)';
            }
        }

        function formatOffset(value) {
            return (value >= 0 ? '+' : '') + value.toFixed(1);
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        // Control Functions
        function sendControlCommand(command, value) {
            if (!isConnected || !mqttClient) {
                showToast('Not connected to MQTT', 'error');
                return;
            }
            
            const message = {
                ...command,
                timestamp: new Date().toISOString(),
                source: 'web'
            };
            
            const mqttMessage = new Paho.MQTT.Message(JSON.stringify(message));
            mqttMessage.destinationName = 'vquail/web/control';
            mqttMessage.qos = 1;
            
            mqttClient.send(mqttMessage);
            
            console.log('Control command sent:', message);
        }

        // Event Listeners
        document.getElementById('toggleFan').addEventListener('click', () => {
            sendControlCommand({ fan: !state.fan });
        });

        document.getElementById('toggleHeat').addEventListener('click', () => {
            sendControlCommand({ heat: !state.heat });
        });

        document.getElementById('fanOn').addEventListener('click', () => {
            sendControlCommand({ fan: true });
        });

        document.getElementById('fanOff').addEventListener('click', () => {
            sendControlCommand({ fan: false });
        });

        document.getElementById('heatOn').addEventListener('click', () => {
            sendControlCommand({ heat: true });
        });

        document.getElementById('heatOff').addEventListener('click', () => {
            sendControlCommand({ heat: false });
        });

        document.getElementById('autoMode').addEventListener('click', () => {
            sendControlCommand({ auto: true });
        });

        document.getElementById('manualMode').addEventListener('click', () => {
            sendControlCommand({ auto: false });
        });

        document.getElementById('bothOn').addEventListener('click', () => {
            sendControlCommand({ fan: true, heat: true });
        });

        document.getElementById('bothOff').addEventListener('click', () => {
            sendControlCommand({ fan: false, heat: false });
        });

        document.getElementById('forcePublish').addEventListener('click', () => {
            requestFullStatus();
            showToast('Requested full status update', 'success');
        });

        // Stage selection
        document.querySelectorAll('.stage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const stage = parseInt(btn.getAttribute('data-stage'));
                const stageConfig = stages[stage];
                
                sendControlCommand({ 
                    stage: stageConfig.name,
                    age: stageConfig.minAge
                });
                
                showToast(`Stage set to ${stageConfig.name}`, 'success');
            });
        });

        // Age control
        document.getElementById('ageDown').addEventListener('click', () => {
            const newAge = Math.max(state.ageDays - 1, stages[state.currentStage].minAge);
            sendControlCommand({ age: newAge });
        });

        document.getElementById('ageUp').addEventListener('click', () => {
            const newAge = Math.min(state.ageDays + 1, stages[state.currentStage].maxAge);
            sendControlCommand({ age: newAge });
        });

        // Calibration control
        document.getElementById('tempCalDown').addEventListener('click', () => {
            sendControlCommand({ adjust_temp: -0.5 });
        });

        document.getElementById('tempCalUp').addEventListener('click', () => {
            sendControlCommand({ adjust_temp: 0.5 });
        });

        document.getElementById('humCalDown').addEventListener('click', () => {
            sendControlCommand({ adjust_hum: -0.5 });
        });

        document.getElementById('humCalUp').addEventListener('click', () => {
            sendControlCommand({ adjust_hum: 0.5 });
        });

        // Settings actions
        document.getElementById('saveSettings').addEventListener('click', () => {
            // Settings are saved automatically when changed
            showToast('Settings saved', 'success');
        });

        document.getElementById('rebootSystem').addEventListener('click', () => {
            if (confirm('Are you sure you want to reboot the system?')) {
                sendControlCommand({ reboot: true });
                showToast('System reboot requested', 'warning');
            }
        });

        document.getElementById('resetCalibration').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset calibration to defaults?')) {
                sendControlCommand({ reset_calibration: true });
                showToast('Calibration reset requested', 'warning');
            }
        });

        function requestFullStatus() {
            if (!isConnected || !mqttClient) return;
            
            const message = {
                request: 'full',
                timestamp: new Date().toISOString()
            };
            
            const mqttMessage = new Paho.MQTT.Message(JSON.stringify(message));
            mqttMessage.destinationName = 'vquail/status/request';
            mqttMessage.qos = 1;
            
            mqttClient.send(mqttMessage);
        }

        function showConnectionStatus(message, type) {
            elements.connectionStatus.textContent = message;
            elements.connectionStatus.className = `connection-status ${type}`;
            
            setTimeout(() => {
                elements.connectionStatus.style.display = 'none';
            }, 3000);
        }

        function showToast(message, type) {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type}`;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Initialize
        function init() {
            // Start MQTT connection
            initMQTT();
            
            // Update time every second
            setInterval(() => {
                const now = new Date();
                elements.currentTime.textContent = now.toLocaleTimeString();
                elements.currentDate.textContent = now.toLocaleDateString();
            }, 1000);
            
            // Request status updates every 30 seconds
            setInterval(() => {
                if (isConnected) {
                    requestFullStatus();
                }
            }, 30000);
            
            // Show welcome message
            setTimeout(() => {
                showToast('VQuail Web Control Interface Ready', 'success');
            }, 2000);
        }

        // Start the application
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
