<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VQuail Dashboard (Optimized)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* (CSS remains the same as your original) */
        :root {
            --primary: #6366f1;
            --primary-light: #8b5cf6;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #cbd5e1;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.4);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 30px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* ... rest of your CSS remains exactly the same ... */
        
        /* Add this new class for MQTT status */
        .mqtt-stats {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            display: flex;
            gap: 10px;
        }
        
        .mqtt-stats span {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation" id="bgAnimation"></div>
    
    <!-- Login Page -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1>VQuail Dashboard</h1>
                <p>
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure Login Required</span>
                </p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorMessage">Invalid credentials</span>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Enter username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-container">
                        <input type="password" id="password" class="form-input" placeholder="Enter password" autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button class="login-btn" id="loginButton" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <div class="login-footer">
                    <p><i class="fas fa-cloud"></i> Poultry IoT System - Optimized MQTT</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>VQuail Dashboard</h1>
                <p id="connectionInfo">
                    <i class="fas fa-clock"></i>
                    <span>Sensor interval: 30 minutes</span>
                    <span id="nextUpdateBadge" class="interval-badge"></span>
                    <span id="sensorValidationStatus" class="validation-indicator validating" style="display: none;">
                        <i class="fas fa-microchip"></i> Validating...
                    </span>
                </p>
                <div class="mqtt-stats" id="mqttStats">
                    <span id="mqttQueueStatus">Queue: 0</span>
                    <span id="mqttPublishCount">Messages: 0</span>
                    <span id="mqttUpdateMode">Mode: Batched</span>
                </div>
            </div>
            <div class="header-right">
                <div class="connection-status" id="connectionStatus">
                    <div class="status-dot disconnected" id="mqttStatusDot"></div>
                    <span id="mqttStatusText">Disconnected</span>
                </div>
                <button class="action-btn" id="connectBtn" onclick="connectMQTT()">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <button class="action-btn" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button class="action-btn danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-text">Connecting to MQTT...</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="dashboard-grid">
                <!-- Temperature Card -->
                <div class="card temperature-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon temp">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div>
                                <h3>Temperature</h3>
                                <p id="tempStatus">--</p>
                            </div>
                        </div>
                        <div id="tempBadge" class="status-indicator">--</div>
                    </div>
                    <div class="card-body">
                        <div class="sensor-value-container">
                            <div class="sensor-value">
                                <span id="temperatureValue">--</span>
                                <span class="sensor-unit">°C</span>
                            </div>
                            <div class="value-trend" id="tempTrend">--</div>
                        </div>
                        
                        <!-- Validation Progress -->
                        <div class="validation-progress" id="tempValidationProgress" style="display: none;">
                            <div class="validation-dots">
                                <div class="validation-dot" id="tempDot1"></div>
                                <div class="validation-dot" id="tempDot2"></div>
                                <div class="validation-dot" id="tempDot3"></div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                <span id="tempValidationText">Validating sensor readings...</span>
                            </div>
                        </div>
                        
                        <div class="sensor-details">
                            <div class="detail-item">
                                <div class="detail-label">Raw Value</div>
                                <div class="detail-value" id="rawTemp">-- °C</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Offset</div>
                                <div class="detail-value" id="tempOffset">±0.0 °C</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Updated</div>
                                <div class="detail-value" id="tempUpdated">--:--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Next Update</div>
                                <div class="detail-value" id="tempNextUpdate">--</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Optimal Range</span>
                                <span id="tempRange">24-28°C</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="tempProgress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Humidity Card -->
                <div class="card humidity-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon hum">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div>
                                <h3>Humidity</h3>
                                <p id="humStatus">--</p>
                            </div>
                        </div>
                        <div id="humBadge" class="status-indicator">--</div>
                    </div>
                    <div class="card-body">
                        <div class="sensor-value-container">
                            <div class="sensor-value">
                                <span id="humidityValue">--</span>
                                <span class="sensor-unit">%</span>
                            </div>
                            <div class="value-trend" id="humTrend">--</div>
                        </div>
                        
                        <!-- Validation Progress -->
                        <div class="validation-progress" id="humValidationProgress" style="display: none;">
                            <div class="validation-dots">
                                <div class="validation-dot" id="humDot1"></div>
                                <div class="validation-dot" id="humDot2"></div>
                                <div class="validation-dot" id="humDot3"></div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                <span id="humValidationText">Validating sensor readings...</span>
                            </div>
                        </div>
                        
                        <div class="sensor-details">
                            <div class="detail-item">
                                <div class="detail-label">Raw Value</div>
                                <div class="detail-value" id="rawHum">-- %</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Offset</div>
                                <div class="detail-value" id="humOffset">±0.0 %</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Updated</div>
                                <div class="detail-value" id="humUpdated">--:--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Next Update</div>
                                <div class="detail-value" id="humNextUpdate">--</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Optimal Range</span>
                                <span id="humRange">55-65%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="humProgress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Status Card -->
                <div class="card system-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon system">
                                <i class="fas fa-server"></i>
                            </div>
                            <div>
                                <h3>System Status</h3>
                                <p id="systemStatus">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="sensor-details">
                            <div class="detail-item">
                                <div class="detail-label">Life Stage</div>
                                <div class="detail-value" id="lifeStage">--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Age</div>
                                <div class="detail-value" id="quailAge">-- days</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">WiFi Signal</div>
                                <div class="detail-value" id="wifiRSSI">-- dBm</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Uptime</div>
                                <div class="detail-value" id="systemUptime">--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Control Source</div>
                                <div class="detail-value" id="controlSource">--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Heap Free</div>
                                <div class="detail-value" id="freeHeap">-- KB</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Sensor Status</div>
                                <div class="detail-value" id="sensorValidation">--</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Valid Readings</div>
                                <div class="detail-value" id="consecutiveReadings">0</div>
                            </div>
                        </div>
                        
                        <!-- MQTT Optimization Info -->
                        <div style="margin-top: 20px; padding: 15px; background: var(--bg-glass); border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                <i class="fas fa-tachometer-alt"></i> MQTT Optimization
                            </div>
                            <div class="sensor-details" style="grid-template-columns: repeat(2, 1fr);">
                                <div class="detail-item">
                                    <div class="detail-label">Queue Size</div>
                                    <div class="detail-value" id="mqttQueueSize">0</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Message Count</div>
                                    <div class="detail-value" id="mqttMessageCount">0</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Update Mode</div>
                                    <div class="detail-value" id="updateMode">Batched</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Last Batch</div>
                                    <div class="detail-value" id="lastBatch">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Card -->
                <div class="card control-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon control">
                                <i class="fas fa-sliders-h"></i>
                            </div>
                            <div>
                                <h3>Quick Control</h3>
                                <p id="controlMode">AUTO</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mode-warning" id="modeWarning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Switch to MANUAL mode for direct control</div>
                        </div>
                        
                        <div class="mode-toggle">
                            <button class="mode-btn active" id="autoModeBtn" onclick="setMode(true)">
                                <i class="fas fa-robot"></i> AUTO
                            </button>
                            <button class="mode-btn" id="manualModeBtn" onclick="setMode(false)">
                                <i class="fas fa-gamepad"></i> MANUAL
                            </button>
                        </div>
                        
                        <div class="control-grid">
                            <button class="control-btn" id="fanOnBtn" onclick="controlDevice('fan', true)">
                                <i class="fas fa-fan"></i>
                                <span>FAN ON</span>
                            </button>
                            <button class="control-btn" id="fanOffBtn" onclick="controlDevice('fan', false)">
                                <i class="fas fa-fan"></i>
                                <span>FAN OFF</span>
                            </button>
                            <button class="control-btn" id="heatOnBtn" onclick="controlDevice('heat', true)">
                                <i class="fas fa-fire"></i>
                                <span>HEAT ON</span>
                            </button>
                            <button class="control-btn" id="heatOffBtn" onclick="controlDevice('heat', false)">
                                <i class="fas fa-fire"></i>
                                <span>HEAT OFF</span>
                            </button>
                        </div>
                        
                        <div class="control-quick-buttons">
                            <button class="action-btn success" onclick="controlBoth(true)">
                                <i class="fas fa-bolt"></i> BOTH ON
                            </button>
                            <button class="action-btn danger" onclick="controlBoth(false)">
                                <i class="fas fa-power-off"></i> BOTH OFF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Life Stage Control -->
            <div class="card stage-card" style="margin-bottom: 40px;">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-seedling" style="color: var(--success); font-size: 28px;"></i>
                        <div>
                            <h3>Life Stage Control</h3>
                            <p>Growth Stages Selection</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stage-grid">
                        <button class="stage-btn" id="stageBroodW1" onclick="setLifeStage('BROODING_WEEK1')">
                            <i class="fas fa-baby"></i>
                            <div>Brood Week 1</div>
                            <small>0-7 days | 35-37°C</small>
                        </button>
                        <button class="stage-btn" id="stageBroodW2" onclick="setLifeStage('BROODING_WEEK2')">
                            <i class="fas fa-child"></i>
                            <div>Brood Week 2</div>
                            <small>8-14 days | 32-35°C</small>
                        </button>
                        <button class="stage-btn" id="stageGrower" onclick="setLifeStage('GROWER_WEEK3_6')">
                            <i class="fas fa-chicken"></i>
                            <div>Grower</div>
                            <small>15-42 days | 24-28°C</small>
                        </button>
                        <button class="stage-btn" id="stageAdult" onclick="setLifeStage('ADULT_LAYER')">
                            <i class="fas fa-egg"></i>
                            <div>Adult Layer</div>
                            <small>43+ days | 20-24°C</small>
                        </button>
                    </div>
                    
                    <div class="age-control">
                        <div style="font-weight: 600;">Current Age:</div>
                        <div class="age-value" id="currentAgeDisplay">0</div>
                        <div style="color: var(--text-secondary);">days</div>
                        <div class="age-buttons">
                            <button class="age-btn decrease" onclick="adjustAge(-1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="age-btn increase" onclick="adjustAge(1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration & System Controls -->
            <div class="card calibration-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tools" style="color: var(--warning); font-size: 28px;"></i>
                        <div>
                            <h3>Calibration</h3>
                            <p>Adjust the sensor offset</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calibration-controls">
                        <div class="calibration-item">
                            <h4 class="text-center">Temperature Offset</h4>
                            <div class="calibration-value" id="tempCalValue">0.0°C</div>
                            <div class="calibration-buttons">
                                <button class="calibration-btn secondary" onclick="adjustCalibration('temp', -0.5)">
                                    <i class="fas fa-minus"></i> 0.5
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('temp', -0.1)">
                                    <i class="fas fa-minus"></i> 0.1
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('temp', 0.1)">
                                    <i class="fas fa-plus"></i> 0.1
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('temp', 0.5)">
                                    <i class="fas fa-plus"></i> 0.5
                                </button>
                            </div>
                        </div>
                        
                        <div class="calibration-item">
                            <h4 class="text-center">Humidity Offset</h4>
                            <div class="calibration-value" id="humCalValue">0.0%</div>
                            <div class="calibration-buttons">
                                <button class="calibration-btn secondary" onclick="adjustCalibration('hum', -0.5)">
                                    <i class="fas fa-minus"></i> 0.5
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('hum', -0.1)">
                                    <i class="fas fa-minus"></i> 0.1
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('hum', 0.1)">
                                    <i class="fas fa-plus"></i> 0.1
                                </button>
                                <button class="calibration-btn secondary" onclick="adjustCalibration('hum', 0.5)">
                                    <i class="fas fa-plus"></i> 0.5
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-controls">
                        <button class="action-btn success" onclick="saveCalibration()">
                            <i class="fas fa-save"></i> Save Calibration
                        </button>
                        <button class="action-btn" onclick="resetCalibration()">
                            <i class="fas fa-undo"></i> Reset Calibration
                        </button>
                        <button class="action-btn warning" onclick="requestStatus()">
                            <i class="fas fa-sync-alt"></i> Refresh Status
                        </button>
                        <button class="action-btn danger" onclick="sendReboot()">
                            <i class="fas fa-redo"></i> Reboot Device
                        </button>
                        <button class="action-btn info" onclick="forceSensorRead()">
                            <i class="fas fa-microchip"></i> Force Sensor Read
                        </button>
                        <button class="action-btn" onclick="toggleUpdateMode()" id="updateModeBtn">
                            <i class="fas fa-exchange-alt"></i> Switch to Single
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            mqtt: {
                host: '514ee1c5407448169298c78647ad26b9.s1.eu.hivemq.cloud',
                port: 8884,
                username: 'vquail',
                password: 'Vquail12345',
                clientId: 'vquail-web-' + Math.random().toString(36).substr(2, 9)
            },
            web: {
                username: 'vquail',
                password: 'vquail123'
            },
            sensorInterval: 1800000,
            statusUpdateInterval: 30000,
            // MQTT Optimization settings
            mqtt: {
                qos: 1,
                minPublishInterval: 2000, // Minimum 2 seconds between publishes
                batchMode: true, // Enable batched updates
                batchInterval: 120000, // 2 minutes for batched updates
                queueSize: 5 // Maximum queued messages
            }
        };

        // State
        let mqttClient = null;
        let isConnected = false;
        let isAuthenticated = false;
        let useBatchMode = true;
        
        // MQTT Statistics
        let mqttPublishCount = 0;
        let mqttQueueSize = 0;
        let lastBatchUpdate = 0;
        let lastSingleUpdate = 0;
        
        let systemState = {
            temp: -99.9,
            hum: -99.9,
            rawTemp: 0,
            rawHum: 0,
            tempOffset: 0,
            humOffset: 0,
            fan: false,
            heat: false,
            auto: true,
            stage: '--',
            age: 0,
            wifi_rssi: 0,
            control_channel: '--',
            alarm: false,
            alarm_message: '',
            uptime: 0,
            free_heap: 0,
            lastUpdate: null,
            sensor_online: false,
            sensor_validated: false,
            sensor_fail_count: 0,
            consecutive_valid_readings: 0,
            mqtt_queue: 0,
            mqtt_publish_count: 0
        };

        // Control throttling
        let lastControlTime = 0;
        let lastCommandTime = {};
        let commandQueue = [];
        const MIN_COMMAND_INTERVAL = 2000; // 2 seconds minimum between commands

        // Life Stages
        const LIFE_STAGES = {
            'BROODING_WEEK1': { 
                name: 'Brood Week 1', 
                minAge: 0, 
                maxAge: 7,
                tempMin: 35,
                tempMax: 37,
                humMin: 60,
                humMax: 70
            },
            'BROODING_WEEK2': { 
                name: 'Brood Week 2', 
                minAge: 8, 
                maxAge: 14,
                tempMin: 32,
                tempMax: 35,
                humMin: 60,
                humMax: 70
            },
            'GROWER_WEEK3_6': { 
                name: 'Grower', 
                minAge: 15, 
                maxAge: 42,
                tempMin: 24,
                tempMax: 28,
                humMin: 55,
                humMax: 65
            },
            'ADULT_LAYER': { 
                name: 'Adult Layer', 
                minAge: 43, 
                maxAge: 999,
                tempMin: 20,
                tempMax: 24,
                humMin: 50,
                humMax: 60
            }
        };

        let currentStage = 'GROWER_WEEK3_6';
        let currentAge = 0;
        let calibrationPending = {
            temp: 0,
            hum: 0
        };

        // Initialize background particles
        function initBackgroundAnimation() {
            const container = document.getElementById('bgAnimation');
            const particleCount = 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 100 + 20;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 30 + 10}s`;
                
                container.appendChild(particle);
            }
        }

        // Authentication
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');

            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }

            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

            setTimeout(() => {
                if (username === CONFIG.web.username && password === CONFIG.web.password) {
                    isAuthenticated = true;
                    
                    const authData = {
                        authenticated: true,
                        timestamp: Date.now(),
                        sessionId: 'session_' + Math.random().toString(36).substr(2, 16)
                    };
                    
                    sessionStorage.setItem('vquail_auth', JSON.stringify(authData));
                    
                    const loginCard = document.querySelector('.login-card');
                    loginCard.style.animation = 'slideUp 0.5s ease-in reverse forwards';
                    
                    setTimeout(() => {
                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('dashboardContainer').style.display = 'block';
                        showNotification('Login successful!', 'success');
                        
                        document.getElementById('password').value = '';
                        
                        setTimeout(connectMQTT, 1000);
                    }, 500);
                } else {
                    showLoginError('Invalid username or password');
                    document.getElementById('password').value = '';
                    
                    const loginCard = document.querySelector('.login-card');
                    loginCard.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        loginCard.style.animation = '';
                    }, 500);
                    
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                }
            }, 1000);
        }

        // MQTT Connection (Optimized)
        function connectMQTT() {
            if (!isAuthenticated) {
                showNotification('Please login first', 'error');
                return;
            }
            
            if (mqttClient && mqttClient.connected) {
                showNotification('Already connected', 'info');
                return;
            }

            updateConnectionStatus('connecting');
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting';
            
            document.getElementById('loadingSpinner').style.display = 'flex';

            const options = {
                username: CONFIG.mqtt.username,
                password: CONFIG.mqtt.password,
                clientId: CONFIG.mqtt.clientId,
                clean: true,
                reconnectPeriod: 3000,
                connectTimeout: 10000,
                rejectUnauthorized: false
            };

            const wsUrl = `wss://${CONFIG.mqtt.host}:${CONFIG.mqtt.port}/mqtt`;

            try {
                mqttClient = mqtt.connect(wsUrl, options);

                mqttClient.on('connect', () => {
                    console.log('MQTT Connected');
                    isConnected = true;
                    updateConnectionStatus('connected');
                    showNotification('Connected to MQTT broker', 'success');
                    connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                    connectBtn.disabled = false;
                    
                    document.getElementById('loadingSpinner').style.display = 'none';
                    
                    // Subscribe to topics with QoS 1
                    mqttClient.subscribe('vquail/status/batched', { qos: 1 });
                    mqttClient.subscribe('vquail/status/device', { qos: 1 });
                    mqttClient.subscribe('vquail/sensors', { qos: 1 });
                    mqttClient.subscribe('vquail/status/system', { qos: 1 });
                    mqttClient.subscribe('vquail/calibration/current', { qos: 1 });
                    mqttClient.subscribe('vquail/alarm', { qos: 1 });
                    
                    // Subscribe to control topics
                    mqttClient.subscribe('vquail/web/control', { qos: 1 });
                    mqttClient.subscribe('vquail/calibration', { qos: 1 });
                    mqttClient.subscribe('vquail/status/request', { qos: 1 });
                    
                    // Request initial status
                    setTimeout(requestStatus, 1000);
                });

                mqttClient.on('message', (topic, message) => {
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', (error) => {
                    console.error('MQTT Error:', error);
                    updateConnectionStatus('disconnected');
                    connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
                    connectBtn.disabled = false;
                    document.getElementById('loadingSpinner').style.display = 'none';
                    
                    showNotification(`Connection error: ${error.message}`, 'error');
                });

                mqttClient.on('close', () => {
                    console.log('MQTT Connection closed');
                    isConnected = false;
                    updateConnectionStatus('disconnected');
                    connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
                    connectBtn.disabled = false;
                    document.getElementById('loadingSpinner').style.display = 'none';
                });

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('disconnected');
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
                connectBtn.disabled = false;
                document.getElementById('loadingSpinner').style.display = 'none';
                showNotification(`Connection failed: ${error.message}`, 'error');
            }
        }

        // Handle MQTT messages (Optimized)
        function handleMQTTMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                // Handle batched updates
                if (topic === 'vquail/status/batched') {
                    processBatchedUpdate(data);
                    lastBatchUpdate = Date.now();
                    updateMQTTStats();
                    return;
                }
                
                // Handle individual topics
                switch (topic) {
                    case 'vquail/status/device':
                        updateDeviceState(data);
                        break;
                    case 'vquail/sensors':
                        updateSensorData(data);
                        break;
                    case 'vquail/calibration/current':
                        updateCalibrationData(data);
                        break;
                    case 'vquail/alarm':
                        handleAlarm(data);
                        break;
                    case 'vquail/status/system':
                        updateSystemStatus(data);
                        break;
                }
                
                updateUI();
                
            } catch (error) {
                console.error('Error processing message:', error);
            }
        }

        // Process batched update
        function processBatchedUpdate(data) {
            // Update all state from batched data
            Object.assign(systemState, data);
            
            // Update MQTT statistics
            mqttQueueSize = data.mqtt_queue || 0;
            mqttPublishCount = data.mqtt_publish_count || 0;
            
            // Update validation state
            if (data.consecutive_valid_readings) {
                updateValidationProgress(data.consecutive_valid_readings);
            }
            
            // Update stage
            if (data.stage_index !== undefined) {
                const stages = ['BROODING_WEEK1', 'BROODING_WEEK2', 'GROWER_WEEK3_6', 'ADULT_LAYER'];
                if (data.stage_index >= 0 && data.stage_index < stages.length) {
                    currentStage = stages[data.stage_index];
                }
            }
            
            // Update age
            if (data.age !== undefined) {
                currentAge = data.age;
            }
            
            // Update timestamp
            systemState.lastUpdate = new Date();
            
            updateUI();
            updateMQTTStats();
            
            console.log('[MQTT] Batched update processed');
        }

        // Update MQTT statistics display
        function updateMQTTStats() {
            document.getElementById('mqttQueueSize').textContent = mqttQueueSize;
            document.getElementById('mqttMessageCount').textContent = mqttPublishCount;
            document.getElementById('updateMode').textContent = useBatchMode ? 'Batched' : 'Single';
            document.getElementById('lastBatch').textContent = lastBatchUpdate ? 
                new Date(lastBatchUpdate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
            
            // Update header stats
            document.getElementById('mqttQueueStatus').textContent = `Queue: ${mqttQueueSize}`;
            document.getElementById('mqttPublishCount').textContent = `Msgs: ${mqttPublishCount}`;
            document.getElementById('mqttUpdateMode').textContent = `Mode: ${useBatchMode ? 'Batched' : 'Single'}`;
        }

        // Command throttling
        function sendCommand(topic, command, highPriority = false) {
            const now = Date.now();
            
            // Throttle commands
            if (!highPriority && now - lastControlTime < MIN_COMMAND_INTERVAL) {
                // Queue the command
                commandQueue.push({topic, command, timestamp: now});
                processCommandQueue();
                return false;
            }
            
            // Send immediately
            if (mqttClient && isConnected) {
                mqttClient.publish(topic, JSON.stringify(command), { qos: 1 });
                lastControlTime = now;
                mqttPublishCount++;
                updateMQTTStats();
                return true;
            }
            
            return false;
        }

        function processCommandQueue() {
            if (commandQueue.length === 0) return;
            
            const now = Date.now();
            const oldestCommand = commandQueue[0];
            
            // If enough time has passed, send the oldest command
            if (now - lastControlTime >= MIN_COMMAND_INTERVAL) {
                if (mqttClient && isConnected) {
                    mqttClient.publish(oldestCommand.topic, JSON.stringify(oldestCommand.command), { qos: 1 });
                    lastControlTime = now;
                    mqttPublishCount++;
                    commandQueue.shift(); // Remove sent command
                    updateMQTTStats();
                }
            }
            
            // Process next command after delay
            if (commandQueue.length > 0) {
                setTimeout(processCommandQueue, MIN_COMMAND_INTERVAL);
            }
        }

        // Control Functions (with throttling)
        function controlDevice(device, state) {
            if (!isConnected) {
                showNotification('Not connected to MQTT', 'error');
                return;
            }

            if (systemState.auto) {
                showNotification('Switch to MANUAL mode first', 'warning');
                return;
            }

            const command = {
                [device]: state,
                timestamp: Date.now(),
                source: 'web'
            };

            const sent = sendCommand('vquail/web/control', command, true);
            
            if (sent) {
                showNotification(`${device.toUpperCase()} turned ${state ? 'ON' : 'OFF'}`, 'success');
                
                // Update UI immediately
                if (device === 'fan') {
                    systemState.fan = state;
                } else if (device === 'heat') {
                    systemState.heat = state;
                }
                updateControlButtons();
            }
        }

        function setMode(auto) {
            if (!isConnected) {
                showNotification('Not connected', 'error');
                return;
            }

            const command = {
                auto: auto,
                timestamp: Date.now(),
                source: 'web'
            };

            sendCommand('vquail/web/control', command, true);
            showNotification(`${auto ? 'AUTO' : 'MANUAL'} mode activated`, 'success');
            
            systemState.auto = auto;
            updateControlUI();
        }

        // Toggle between batch and single update mode
        function toggleUpdateMode() {
            useBatchMode = !useBatchMode;
            const btn = document.getElementById('updateModeBtn');
            
            if (useBatchMode) {
                btn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Single';
                showNotification('Switched to batched update mode (every 2 minutes)', 'info');
            } else {
                btn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Batched';
                showNotification('Switched to single update mode (on change)', 'info');
            }
            
            updateMQTTStats();
        }

        // Request status update
        function requestStatus() {
            if (!isConnected) return;
            
            const command = {
                request: "full",
                timestamp: Date.now(),
                source: 'web'
            };

            sendCommand('vquail/status/request', command, true);
            showNotification('Status update requested', 'info');
        }

        // Update functions for individual topics
        function updateDeviceState(data) {
            systemState.fan = data.fan || systemState.fan;
            systemState.heat = data.heat || systemState.heat;
            systemState.auto = data.auto || systemState.auto;
            systemState.stage = data.stage || systemState.stage;
            systemState.age = data.age || systemState.age;
            systemState.control_channel = data.control_channel || systemState.control_channel;
            
            if (data.alarm_active) {
                systemState.alarm = true;
                systemState.alarm_message = data.alarm || '';
            } else {
                systemState.alarm = false;
                systemState.alarm_message = '';
            }
            
            systemState.lastUpdate = new Date();
        }

        function updateSensorData(data) {
            if (data.temp > -99 && data.hum > -99) {
                systemState.temp = data.temp;
                systemState.hum = data.hum;
                systemState.rawTemp = data.raw_temp || systemState.rawTemp;
                systemState.rawHum = data.raw_hum || systemState.rawHum;
                systemState.sensor_online = data.sensor_online || false;
                systemState.sensor_validated = data.sensor_validated || false;
                systemState.consecutive_valid_readings = data.consecutive_valid_readings || 0;
                
                if (data.consecutive_valid_readings) {
                    updateValidationProgress(data.consecutive_valid_readings);
                }
            }
        }

        // UI Update functions (optimized)
        function updateUI() {
            // Batch DOM updates
            requestAnimationFrame(() => {
                updateSensorDisplay();
                updateSystemDisplay();
                updateControlUI();
                updateStageDisplay();
                updateCalibrationDisplay();
                updateStatusBadges();
                updateProgressBars();
                updateNextSensorTime();
            });
        }

        function updateSensorDisplay() {
            if (systemState.temp > -99 && systemState.hum > -99) {
                document.getElementById('temperatureValue').textContent = systemState.temp.toFixed(1);
                document.getElementById('humidityValue').textContent = systemState.hum.toFixed(1);
                document.getElementById('rawTemp').textContent = systemState.rawTemp.toFixed(1) + '°C';
                document.getElementById('tempOffset').textContent = (systemState.tempOffset > 0 ? '+' : '') + systemState.tempOffset.toFixed(1) + '°C';
                document.getElementById('rawHum').textContent = systemState.rawHum.toFixed(1) + '%';
                document.getElementById('humOffset').textContent = (systemState.humOffset > 0 ? '+' : '') + systemState.humOffset.toFixed(1) + '%';
                document.getElementById('tempStatus').textContent = systemState.sensor_validated ? 'Validated' : 'Validating...';
                document.getElementById('humStatus').textContent = systemState.sensor_validated ? 'Validated' : 'Validating...';
            } else {
                document.getElementById('temperatureValue').textContent = '--';
                document.getElementById('humidityValue').textContent = '--';
                document.getElementById('tempStatus').textContent = systemState.sensor_online ? 'Validating...' : 'Offline';
                document.getElementById('humStatus').textContent = systemState.sensor_online ? 'Validating...' : 'Offline';
            }
            
            if (systemState.lastUpdate) {
                const timeStr = systemState.lastUpdate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('tempUpdated').textContent = timeStr;
                document.getElementById('humUpdated').textContent = timeStr;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initBackgroundAnimation();
            
            if (checkAuth()) {
                setTimeout(connectMQTT, 1000);
            }
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
            }
            
            // Enter key login
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            
            // Auto-reconnect
            setInterval(() => {
                if (mqttClient && mqttClient.disconnected && !document.getElementById('connectBtn').disabled) {
                    connectMQTT();
                }
            }, 30000);
            
            // Update next sensor time every minute
            setInterval(updateNextSensorTime, 60000);
            
            // Update MQTT stats every 30 seconds
            setInterval(updateMQTTStats, 30000);
        });

        // Helper functions (same as before)
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.password-toggle i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleButton.className = 'fas fa-eye';
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDiv.style.display = 'flex';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                if (mqttClient) {
                    mqttClient.end();
                }
                
                isAuthenticated = false;
                sessionStorage.removeItem('vquail_auth');
                
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                document.getElementById('dashboardContainer').style.opacity = '0';
                document.getElementById('dashboardContainer').style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    document.getElementById('dashboardContainer').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.getElementById('dashboardContainer').style.opacity = '1';
                    document.getElementById('dashboardContainer').style.transform = 'translateY(0)';
                    
                    document.getElementById('loginButton').disabled = false;
                    document.getElementById('loginButton').innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                    
                    document.querySelector('.login-card').style.animation = 'slideUp 0.5s ease-out';
                    
                    showNotification('Logged out successfully', 'info');
                }, 300);
            }
        }

        function checkAuth() {
            const authData = sessionStorage.getItem('vquail_auth');
            
            if (authData) {
                const data = JSON.parse(authData);
                if (data.authenticated && Date.now() - data.timestamp < 8 * 60 * 60 * 1000) {
                    isAuthenticated = true;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').style.display = 'block';
                    return true;
                }
            }
            return false;
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('mqttStatusDot');
            const text = document.getElementById('mqttStatusText');
            const statusDiv = document.getElementById('connectionStatus');
            
            if (dot) dot.className = 'status-dot ' + status;
            if (text) text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (statusDiv) {
                statusDiv.style.animation = 'none';
                setTimeout(() => {
                    statusDiv.style.animation = 'pulse 0.5s';
                }, 10);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            if (!notification || !messageElement) return;
            
            notification.style.display = 'none';
            
            notification.className = `notification ${type}`;
            messageElement.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) reverse forwards';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.animation = '';
                }, 500);
            }, 4000);
        }

        // The rest of your helper functions (updateValidationProgress, updateControlUI, 
        // updateStageDisplay, updateCalibrationDisplay, updateStatusBadges, 
        // updateProgressBars, updateNextSensorTime, etc.) remain the same as your original code
        
        // Add these placeholder functions for completeness
        function updateValidationProgress(count) {
            // Same as your original implementation
        }
        
        function updateControlUI() {
            // Same as your original implementation
        }
        
        function updateSystemDisplay() {
            // Same as your original implementation
        }
        
        // ... include all your other UI update functions from the original code
        
    </script>
</body>
</html>
